<!DOCTYPE html><html lang="default" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>（一）初步认识EVM字节码 | Jiahao Luo</title><meta name="author" content="Michael(Jiahao) Luo"><meta name="copyright" content="Michael(Jiahao) Luo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="（一）初步认识EVM字节码（二）状态变量的赋值（三）函数调用  前言 在开始之前，我们默认读者已经初步理解 EVM, 包括字节码、操作码、堆栈、内存、存储、calldata。理解 ABI，能够根据文档计算对应变量的 ABI，并且具有一定的编译基础。因此，如果阅读过程中觉得困难，请先阅读 EVM 的其他文章，如 初步理解以太坊虚拟机。 本文编译器版本采用 0.8.10，EVM 版本是 London">
<meta property="og:type" content="article">
<meta property="og:title" content="（一）初步认识EVM字节码">
<meta property="og:url" content="https://www.blog-blockchain.xyz/evm/evm-basic-bytecode/index.html">
<meta property="og:site_name" content="Jiahao Luo">
<meta property="og:description" content="（一）初步认识EVM字节码（二）状态变量的赋值（三）函数调用  前言 在开始之前，我们默认读者已经初步理解 EVM, 包括字节码、操作码、堆栈、内存、存储、calldata。理解 ABI，能够根据文档计算对应变量的 ABI，并且具有一定的编译基础。因此，如果阅读过程中觉得困难，请先阅读 EVM 的其他文章，如 初步理解以太坊虚拟机。 本文编译器版本采用 0.8.10，EVM 版本是 London">
<meta property="og:locale">
<meta property="og:image" content="https://www.blog-blockchain.xyz/images/evm-bytecode.png">
<meta property="article:published_time" content="2022-08-24T10:29:33.000Z">
<meta property="article:modified_time" content="2024-11-15T14:30:54.921Z">
<meta property="article:author" content="Michael(Jiahao) Luo">
<meta property="article:tag" content="evm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.blog-blockchain.xyz/images/evm-bytecode.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "（一）初步认识EVM字节码",
  "url": "https://www.blog-blockchain.xyz/evm/evm-basic-bytecode/",
  "image": "https://www.blog-blockchain.xyz/images/evm-bytecode.png",
  "datePublished": "2022-08-24T10:29:33.000Z",
  "dateModified": "2024-11-15T14:30:54.921Z",
  "author": [
    {
      "@type": "Person",
      "name": "Michael(Jiahao) Luo",
      "url": "https://www.blog-blockchain.xyz/"
    }
  ]
}</script><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://www.blog-blockchain.xyz/evm/evm-basic-bytecode/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/pwa/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/pwa/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/pwa/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/pwa/16.png"/><link rel="mask-icon" href="/pwa/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css?v=5.3.5"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?372b8854d18acf62880149b1e08e1901";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=QXcJQjXxTMeUwnWykFW2xw"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'QXcJQjXxTMeUwnWykFW2xw')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'QXcJQjXxTMeUwnWykFW2xw', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '（一）初步认识EVM字节码',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Jiahao Luo" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/site-avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">80</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archive</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Jiahao Luo</span></a><a class="nav-page-title" href="/"><span class="site-name">（一）初步认识EVM字节码</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archive</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">（一）初步认识EVM字节码</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-08-24T10:29:33.000Z" title="Created 2022-08-24 18:29:33">2022-08-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-11-15T14:30:54.921Z" title="Updated 2024-11-15 22:30:54">2024-11-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/evm/">evm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">6.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>26mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><blockquote>
<ol class="series-items"><li><a href="/evm/evm-basic-bytecode/" title="（一）初步认识EVM字节码">（一）初步认识EVM字节码</a></li><li><a href="/evm/state-variable/" title="（二）状态变量的赋值">（二）状态变量的赋值</a></li><li><a href="/evm/function-call/" title="（三）函数调用">（三）函数调用</a></li></ol>
</blockquote>
<h1>前言</h1>
<p>在开始之前，我们默认读者已经初步理解 EVM, 包括字节码、操作码、堆栈、内存、存储、calldata。理解 ABI，能够根据文档计算对应变量的 ABI，并且具有一定的编译基础。因此，如果阅读过程中觉得困难，请先阅读 EVM 的其他文章，如 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/learnerLj/geth-analyze/blob/main/analyzeSourceCode/EVM%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8E%9F%E7%90%86/%E5%88%9D%E6%AD%A5%E7%90%86%E8%A7%A3%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%99%9A%E6%8B%9F%E6%9C%BA.md">初步理解以太坊虚拟机</a>。</p>
<p>本文编译器版本采用 <code>0.8.10</code>，EVM 版本是 <code>London</code>。没有特殊说明的条件下，默认关闭编译优化。建议读者复现时采用相同的编译器和 EVM，避免不一样的结果，虽然一般而言小版本的变化区别不大。</p>
<h1>合约创建</h1>
<h2 id="字节码和运行时字节码">字节码和运行时字节码</h2>
<p>我们首先部署一个空的合约 <code>Empty.sol</code>，观察合约部署的字节码。这里需要注意区分运行时代码和部署时代码，creation bytecode 在部署后被舍弃，RETURN 的运行时字节码写入区块链。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line"></span><br><span class="line">pragma solidity &gt;=0.7.0 &lt;0.9.0;</span><br><span class="line">contract Empty &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 Remix 的部署页面的最下面有编译细节，里面有辅助的部署函数和部署时、运行时的字节码。</p>
<p>部署时的字节码常直接称作 <code>bytecode</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;object&quot;: &quot;6080604052348015600f57600080fd5b50603f80601d6000396000f3fe6080604052600080fdfea2646970667358221220b3cdd68a9a1040f3ba42bb4f6ac7a5ea4dd3119af7649144cd611e3fef9a611564736f6c634300080d0033&quot;,</span><br><span class="line">   &quot;opcodes&quot;: &quot;PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH1 0xF JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH1 0x3F DUP1 PUSH1 0x1D PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN INVALID PUSH1 0x80 PUSH1 0x40 MSTORE PUSH1 0x0 DUP1 REVERT INVALID LOG2 PUSH5 0x6970667358 0x22 SLT KECCAK256 0xB3 0xCD 0xD6 DUP11 SWAP11 LT BLOCKHASH RETURN 0xBA TIMESTAMP 0xBB 0x4F PUSH11 0xC7A5EA4DD3119AF7649144 0xCD PUSH2 0x1E3F 0xEF SWAP11 PUSH2 0x1564 PUSH20 0x6F6C634300080D00330000000000000000000000 &quot;,</span><br></pre></td></tr></table></figure>
<p>我们开始单步调试，具体过程如果不熟悉的话，请阅读 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://remix-ide.readthedocs.io/en/latest/debugger.html">Remix-ide doc</a>，操作码详解可以见 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.evm.codes/">https://www.evm.codes/</a></p>
<ol>
<li><code>PUSH1 0x80 PUSH1 0x40 MSTORE</code></li>
</ol>
<p>偏移 40 字节，0x80 拓展成 256 位，然后写入内存。</p>
<p>按照内存的布局：</p>
<ul>
<li><code>0x00</code> - <code>0x3f</code> (前面 64 字节，占用 2 个 slot): 计算哈希时临时存储数据的空间，在语句之间使用。</li>
<li><code>0x40</code> - <code>0x5f</code> (32 字节，占用 1 个 slot): 当前分配的内存大小 ，或者说是内存指针所在位置（因为可以通过内存空间大小计算内存指针位置）。</li>
<li><code>0x60</code> - <code>0x7f</code> (32 字节，占用 1 个 slot): slot[0]，正式内存，用于保存动态 memory 数组的初始值，而且只读。然后下一个位置 <code>0x80</code> 是开始写入的位置。</li>
</ul>
<p>我们可以知道，0x80 作为了初始的内存指针。</p>
<ol start="2">
<li><code>CALLVALUE DUP1 ISZERO</code></li>
</ol>
<p>判断部署合约时给合约的转账金额是否为 0</p>
<ol start="3">
<li><code>PUSH1 0xF JUMPI JUMPDEST</code></li>
</ol>
<p><code>0xF</code> 是跳转的位置，如果部署合约的 callvalue 为 0，那么 pc 条件跳转到栈 <code>0xF</code> 的位置，也就是下一个最近的 JUMPDEST 的位置。</p>
<ol start="4">
<li><code>POP PUSH1 0x3F DUP1 PUSH1 0x1D PUSH1 0x0 CODECOPY</code></li>
</ol>
<p>POP 后清空了栈里最后一个元素，然后栈的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;, &quot;0x000000000000000000000000000000000000000000000000000000000000001d&quot;, &quot;0x000000000000000000000000000000000000000000000000000000000000003f&quot;, &quot;0x000000000000000000000000000000000000000000000000000000000000003f&quot; ]</span><br></pre></td></tr></table></figure>
<p>最后的 CODECOPY 将会在内存偏移 0 的位置，将字节码偏移 <code>0x1d</code> 后的 <code>3f</code> 个字节复制到内存，直接覆盖原来的值。这里可以知道，存放在临时存储空间。</p>
<ol start="5">
<li><code> PUSH1 0x0 RETURN</code></li>
</ol>
<p>RETURN 前的栈，最后在内存中偏移量为 <code>0x0</code> 处开始的 <code>3f</code> 个字节写入区块链。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;, &quot;0x000000000000000000000000000000000000000000000000000000000000003f&quot; ]</span><br></pre></td></tr></table></figure>
<p>所以 RETURN 的值是，这就是运行时字节码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6080604052600080fdfea26469706673582212201249c699c4827fdd0ee29a1e00afff56e54b23a7995fd367cf89d5f34b9922df64736f6c634300080a0033</span><br></pre></td></tr></table></figure>
<p>我们再对照之前的部署时字节码，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6080604052348015600f57600080fd5b50603f80601d6000396000f3fe6080604052600080fdfea2646970667358221220b3cdd68a9a1040f3ba42bb4f6ac7a5ea4dd3119af7649144cd611e3fef9a611564736f6c634300080d0033</span><br></pre></td></tr></table></figure>
<p>可以发现，有许多的差别，省去了不必要的情况，如部署时的转账不为 0.</p>
<h2 id="EVM-汇编">EVM 汇编</h2>
<p>Remix 产生的 EVM 汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.code</span><br><span class="line">  PUSH 80            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  PUSH 40            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  MSTORE             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  CALLVALUE             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  DUP1             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  ISZERO             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  PUSH [tag] 1            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  JUMPI             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  PUSH 0            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  DUP1             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  REVERT             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">tag 1            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  JUMPDEST             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  POP             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  PUSH #[$] 0000000000000000000000000000000000000000000000000000000000000000            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  DUP1             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  PUSH [$] 0000000000000000000000000000000000000000000000000000000000000000            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  PUSH 0            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  CODECOPY             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  PUSH 0            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">  RETURN             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">.data</span><br><span class="line">  0:</span><br><span class="line">    .code</span><br><span class="line">      PUSH 80            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">      PUSH 40            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">      MSTORE             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">      PUSH 0            contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">      DUP1             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">      REVERT             contract Empty&#123;\r\n    \r\n&#125;</span><br><span class="line">    .data</span><br></pre></td></tr></table></figure>
<p>简单介绍，<code>.code</code> 包括了合约初始化的字节码，执行完之后就会舍弃。<code>.data</code> 开始是运行时的字节码，每个 <code>tag</code> 是基本块，里面是连续执行的指令，通常顺序执行或者跳转到不同的 <code>tag</code>，例如 <code>PUSH [tag] 1</code> 表示跳转到 <code>tag1</code> 的部分。</p>
<p>solc 产生的 EVM 汇编和 solcjs 的 (如 remix 应该采用 solcjs) 汇编有些差异</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">======= Empty.sol:Empty =======</span><br><span class="line">EVM assembly:</span><br><span class="line">    /* &quot;Empty.sol&quot;:69:91  contract Empty&#123;... */</span><br><span class="line">  mstore(0x40, 0x80)</span><br><span class="line">  callvalue</span><br><span class="line">  dup1</span><br><span class="line">  iszero</span><br><span class="line">  tag_1</span><br><span class="line">  jumpi</span><br><span class="line">  0x00</span><br><span class="line">  dup1</span><br><span class="line">  revert</span><br><span class="line">tag_1:</span><br><span class="line">  pop</span><br><span class="line">  dataSize(sub_0)</span><br><span class="line">  dup1</span><br><span class="line">  dataOffset(sub_0)</span><br><span class="line">  0x00</span><br><span class="line">  codecopy</span><br><span class="line">  0x00</span><br><span class="line">  return</span><br><span class="line">stop</span><br><span class="line"></span><br><span class="line">sub_0: assembly &#123;</span><br><span class="line">        /* &quot;Empty.sol&quot;:69:91  contract Empty&#123;... */</span><br><span class="line">      mstore(0x40, 0x80)</span><br><span class="line">      0x00</span><br><span class="line">      dup1</span><br><span class="line">      revert</span><br><span class="line"></span><br><span class="line">    auxdata: 0xa2646970667358221220b4acf947b85370aec1c3e21a1f682830785f96fd0cbcd09512abfffcd7f9e7be64736f6c634300080a0033</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>auxdata</code> 是元数据，是字节码的标识，用的很少。对于压栈操作，直接省略了 <code>push</code> 操作码，给出了数值。</p>
<p>之前提到的都是 callvalue 的值为 0 的情况，现在从汇编看跳转关系可以知道，如果 callvalue 不为 0，那么将会在 <code>sub_0</code> 中 <code>REVERT</code>，说明异常终止，这是因为合约中默认的构造函数是 <code>constructor()&#123;&#125;</code>，因此我们需要指定 <code>payable</code>。</p>
<p>我们来看构造函数具有 <code>payable</code> 的情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line"></span><br><span class="line">pragma solidity &gt;=0.7.0 &lt;0.9.0;</span><br><span class="line">contract Empty&#123;</span><br><span class="line">    constructor() payable&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">======= Empty.sol:Empty =======</span><br><span class="line">EVM assembly:</span><br><span class="line">    /* &quot;Empty.sol&quot;:69:119  contract Empty&#123;... */</span><br><span class="line">  mstore(0x40, 0x80)</span><br><span class="line">  dataSize(sub_0)</span><br><span class="line">  dup1</span><br><span class="line">  dataOffset(sub_0)</span><br><span class="line">  0x00</span><br><span class="line">  codecopy</span><br><span class="line">  0x00</span><br><span class="line">  return</span><br><span class="line">stop</span><br><span class="line"></span><br><span class="line">sub_0: assembly &#123;</span><br><span class="line">        /* &quot;Empty.sol&quot;:69:119  contract Empty&#123;... */</span><br><span class="line">      mstore(0x40, 0x80)</span><br><span class="line">      0x00</span><br><span class="line">      dup1</span><br><span class="line">      revert</span><br><span class="line"></span><br><span class="line">    auxdata: 0xa26469706673582212207c6dad3e26954a2823e1b580d4e9cb6c0365802bbf4dbd146e093af53efe9beb64736f6c634300080a0033</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，汇编中去除了 ISZERO 的判断，因为 callvalue 可以不为 0。</p>
<h2 id="calldata">calldata</h2>
<p>部署合约时的 <code>calldata</code> 即合约的字节码。</p>
<h1>案例分析</h1>
<blockquote>
<p><strong>案例分析和总结的章节</strong>，大部分来自 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s/UWU1nuZaGOM0_IHd5AhyvA">https://mp.weixin.qq.com/s/UWU1nuZaGOM0_IHd5AhyvA</a> ，当初朋友这篇文章还没发出来，只是共享了笔记给我，然后我保存了，半年后就忘了，误以为自己写的。在此道歉。也感谢他的帮助和分享。</p>
</blockquote>
<p>以一个很简单的合约代码为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: UNLICENSED</span><br><span class="line">pragma solidity 0.8.9;</span><br><span class="line">contract Foo &#123;</span><br><span class="line"></span><br><span class="line">    uint x;</span><br><span class="line">    constructor(uint _x) &#123;</span><br><span class="line">        x = _x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function foo() public view returns (uint) &#123;</span><br><span class="line">        return x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 solc 编译，并打印 evm 汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solc --asm --optimize test.sol &gt; test.asm</span><br></pre></td></tr></table></figure>
<p>注：<code>--optimize</code> 表示对 evm bytecode 进行优化，从而可以生成较为精简的汇编代码。</p>
<p>生成如下，代码的作用见注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">======= test.sol:Foo =======</span><br><span class="line">EVM assembly:</span><br><span class="line">    /* &quot;test.sol&quot;:62:656  contract Foo &#123;... */</span><br><span class="line">    // solidity 将前 0x80 字节的内存用作特殊用途。</span><br><span class="line">    // 普通的临时变量等将分配在 0x80 后。</span><br><span class="line">    // 0x40 位置为  free memory pointer</span><br><span class="line">    // 一般智能合约前几条指令都会进行此设置</span><br><span class="line">    // 参考：https://docs.soliditylang.org/en/v0.8.10/internals/layout_in_memory.html</span><br><span class="line">  mstore(0x40, 0x80)</span><br><span class="line">    // 这里汇编代码实际有一定的简写</span><br><span class="line">    // EVM 是栈式虚拟机，实际的指令应该是</span><br><span class="line">    // 00000: PUSH1 0x80</span><br><span class="line">    // 00002: PUSH1 0x40</span><br><span class="line">    // 00004: MSTORE</span><br><span class="line">    // 这也是智能合约开头字节大都是 0x6080604052 的原因</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  //  以下是 constructor 代码。</span><br><span class="line">  //  如果没有 constructor 将直接跳到最后的 codecopy 代码。</span><br><span class="line"></span><br><span class="line">    /* &quot;test.sol&quot;:152:259  constructor(uint _x) &#123;... */</span><br><span class="line">  callvalue  // 交易的 ether 数量</span><br><span class="line">  dup1</span><br><span class="line">  iszero    // 判定是否为 0</span><br><span class="line">  tag_1</span><br><span class="line">  jumpi    // 如果是则跳转</span><br><span class="line">  0x00</span><br><span class="line">  dup1</span><br><span class="line">  revert</span><br><span class="line">  // 不是则这里会触发 revert，因为合约中的 constructor 没有标识 payable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tag_1:</span><br><span class="line">  pop</span><br><span class="line">  mload(0x40)</span><br><span class="line"></span><br><span class="line">  sub(codesize, bytecodeSize)</span><br><span class="line">  // codesize 就是 codesize 指令，会取到执行时代码的总体长度。</span><br><span class="line">  // bytecodeSize 实际是编译器生成的立刻数，编译生成出来的代码总长度。</span><br><span class="line">  // 二者相减，就是构造函数 ABI 编码后数据的长度。</span><br><span class="line"></span><br><span class="line">  dup1</span><br><span class="line">  bytecodeSize</span><br><span class="line">  dup4</span><br><span class="line">  codecopy</span><br><span class="line">  // 从代码的 bytecodeSize 偏移处，copy 长度 codesize-bytecodeSize 的数据到内存中。</span><br><span class="line">  // 实际就是将 constructor 的参数数据放到内存中。</span><br><span class="line"></span><br><span class="line">  dup2</span><br><span class="line">  add</span><br><span class="line">  0x40</span><br><span class="line">  dup2</span><br><span class="line">  swap1</span><br><span class="line">  mstore</span><br><span class="line">  tag_2</span><br><span class="line">  swap2</span><br><span class="line">  tag_3</span><br><span class="line">  jump	// in</span><br><span class="line">        // 这里连续压了两个 tag，先跳 tag_3，在 tag_3 执行结束后跳到 tag_2</span><br><span class="line">        // 可以理解成函数调用。可将 tag_3 当成一个函数，执行完返回这里继续执行。</span><br><span class="line">tag_2:</span><br><span class="line">    // tag_3 已经将 constructor 的参数压在了栈顶</span><br><span class="line">    // 这里可以开始执行 constructor 的代码了。</span><br><span class="line">    /* &quot;test.sol&quot;:183:184  x */</span><br><span class="line">  0x00</span><br><span class="line">    /* &quot;test.sol&quot;:183:189  x = _x */</span><br><span class="line">  sstore</span><br><span class="line">    /* &quot;test.sol&quot;:62:656  contract Foo &#123;... */</span><br><span class="line"></span><br><span class="line">  jump(tag_7)  // constructor 执行完成。跳去 tag_7。</span><br><span class="line">    /* &quot;#utility.yul&quot;:14:198   */</span><br><span class="line"></span><br><span class="line">tag_3:  // 这段代码的作用就是解析 ABI 编译的 constructor 的参数</span><br><span class="line">    /* &quot;#utility.yul&quot;:84:90   */</span><br><span class="line">  0x00</span><br><span class="line">    /* &quot;#utility.yul&quot;:137:139   */</span><br><span class="line">  0x20</span><br><span class="line">    /* &quot;#utility.yul&quot;:125:134   */</span><br><span class="line">  dup3</span><br><span class="line">    /* &quot;#utility.yul&quot;:116:123   */</span><br><span class="line">  dup5</span><br><span class="line">    /* &quot;#utility.yul&quot;:112:135   */</span><br><span class="line">  sub</span><br><span class="line">    /* &quot;#utility.yul&quot;:108:140   */</span><br><span class="line">  slt</span><br><span class="line">    /* &quot;#utility.yul&quot;:105:157   */</span><br><span class="line">  iszero        // 检查参数数据的长度是否小于 0x20</span><br><span class="line">                // 例子的构造函数参数 uint256 正好是这个大小。</span><br><span class="line">  tag_9</span><br><span class="line">  jumpi         // 不小于的情况就跳到 tag_9 去解析数据</span><br><span class="line"></span><br><span class="line">                // 小于的话说明参数传递有问题，revert.</span><br><span class="line">    /* &quot;#utility.yul&quot;:153:154   */</span><br><span class="line">  0x00</span><br><span class="line">    /* &quot;#utility.yul&quot;:150:151   */</span><br><span class="line">  dup1</span><br><span class="line">    /* &quot;#utility.yul&quot;:143:155   */</span><br><span class="line">  revert</span><br><span class="line">    /* &quot;#utility.yul&quot;:105:157   */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tag_9:</span><br><span class="line">  pop           // 这里就是将 memory 中的 ABI 编码数据解码出来压到栈上。</span><br><span class="line">                // 这里就 1 个 uint256 参数，直接取出放在栈顶</span><br><span class="line">    /* &quot;#utility.yul&quot;:176:192   */</span><br><span class="line">  mload</span><br><span class="line">  swap2</span><br><span class="line">    /* &quot;#utility.yul&quot;:14:198   */</span><br><span class="line">  swap1</span><br><span class="line">  pop</span><br><span class="line">  jump	// out   // tag_3 这个“函数” return（即跳到 tag_2）</span><br><span class="line"></span><br><span class="line">   //  constructor 代码结束。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tag_7:      // 将代码中 sub_0 copy 到内存中，返回。</span><br><span class="line">    /* &quot;test.sol&quot;:62:656  contract Foo &#123;... */</span><br><span class="line">  dataSize(sub_0)</span><br><span class="line">  dup1</span><br><span class="line">  dataOffset(sub_0)</span><br><span class="line">  0x00</span><br><span class="line">  codecopy</span><br><span class="line">  0x00</span><br><span class="line">  return    // EVM 执行结束</span><br><span class="line">            // 返回的代码就是合约部署后的代码，相当于 solc --bin-runtime</span><br><span class="line"></span><br><span class="line">stop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 以下是合约主体的代码。</span><br><span class="line">// 在合约部署时，这部分代码完全不会执行到，只是当作纯数据处理。</span><br><span class="line"></span><br><span class="line">// 部署后，有合约调用交易时，会执行这部分代码。</span><br><span class="line">sub_0: assembly &#123;</span><br><span class="line">        /* &quot;test.sol&quot;:62:656  contract Foo &#123;... */</span><br><span class="line">      mstore(0x40, 0x80)</span><br><span class="line">      callvalue</span><br><span class="line">      dup1</span><br><span class="line">      iszero</span><br><span class="line">      tag_1    // 由于合约中没有 receive 或者 fallback 函数</span><br><span class="line">               // 这里判断转账金额不为 0</span><br><span class="line">               // 就会直接 revert</span><br><span class="line">      jumpi</span><br><span class="line">      0x00</span><br><span class="line">      dup1</span><br><span class="line">      revert</span><br><span class="line"></span><br><span class="line">    tag_1:     // 解析 calldata，取 selector</span><br><span class="line">      pop</span><br><span class="line">      jumpi(tag_2, lt(calldatasize, 0x04))</span><br><span class="line">      shr(0xe0, calldataload(0x00))</span><br><span class="line">      dup1</span><br><span class="line">      0xc2985578  // 如果是这个值，则跳 tag_3</span><br><span class="line">      eq</span><br><span class="line">      tag_3</span><br><span class="line">      jumpi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    tag_2:     // 其他情况说明这个交易在尝试调用不存在的函数，revert</span><br><span class="line">      0x00</span><br><span class="line">      dup1</span><br><span class="line">      revert</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      // tag_3 就是上面合约的 foo 代码。</span><br><span class="line">        /* &quot;test.sol&quot;:265:332  function foo() public view returns (uint) &#123;... */</span><br><span class="line">    tag_3:</span><br><span class="line">        /* &quot;test.sol&quot;:301:305  uint */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;test.sol&quot;:324:325  x */</span><br><span class="line">      sload       // 取 x 变量（slot 0）</span><br><span class="line">        /* &quot;test.sol&quot;:265:332  function foo() public view returns (uint) &#123;... */</span><br><span class="line">      mload(0x40)</span><br><span class="line">        /* &quot;#utility.yul&quot;:160:185   */</span><br><span class="line">      swap1</span><br><span class="line">      dup2</span><br><span class="line">      mstore     // 放到内存中</span><br><span class="line">        /* &quot;#utility.yul&quot;:148:150   */</span><br><span class="line">      0x20</span><br><span class="line">        /* &quot;#utility.yul&quot;:133:151   */</span><br><span class="line">      add</span><br><span class="line">        /* &quot;test.sol&quot;:265:332  function foo() public view returns (uint) &#123;... */</span><br><span class="line">      mload(0x40)</span><br><span class="line">      dup1</span><br><span class="line">      swap2</span><br><span class="line">      sub</span><br><span class="line">      swap1</span><br><span class="line">      return     // return</span><br><span class="line"></span><br><span class="line">    // 合约的一些 meta data 参考：https://docs.soliditylang.org/en/v0.8.10/metadata.html#encoding-of-the-metadata-hash-in-the-bytecode</span><br><span class="line">    auxdata: 0xa26469706673582212200337a6d0f8e12d27a37a26e2becb7fe90ee8e3d86a8970e157d9cb79b1a7fe2b64736f6c63430008090033</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整的字节码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  test solc --optimize --opcodes test.sol</span><br><span class="line"></span><br><span class="line">======= test.sol:Foo =======</span><br><span class="line">Opcodes:</span><br><span class="line">// 构造函数及部署代码</span><br><span class="line">PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH2 0x10 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH1 0x40 MLOAD PUSH2 0xD6 CODESIZE SUB DUP1 PUSH2 0xD6 DUP4 CODECOPY DUP2 ADD PUSH1 0x40 DUP2 SWAP1 MSTORE PUSH2 0x2F SWAP2 PUSH2 0x37 JUMP JUMPDEST PUSH1 0x0 SSTORE PUSH2 0x50 JUMP JUMPDEST PUSH1 0x0 PUSH1 0x20 DUP3 DUP5 SUB SLT ISZERO PUSH2 0x49 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP MLOAD SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1 0x78 DUP1 PUSH2 0x5E PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN INVALID</span><br><span class="line"></span><br><span class="line">// 部署后的代码</span><br><span class="line">PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH1 0xF JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH1 0x4 CALLDATASIZE LT PUSH1 0x28 JUMPI PUSH1 0x0 CALLDATALOAD PUSH1 0xE0 SHR DUP1 PUSH4 0xC2985578 EQ PUSH1 0x2D JUMPI JUMPDEST PUSH1 0x0 DUP1 REVERT JUMPDEST PUSH1 0x0 SLOAD PUSH1 0x40 MLOAD SWAP1 DUP2 MSTORE PUSH1 0x20 ADD PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 RETURN INVALID</span><br><span class="line"></span><br><span class="line">// auxdata，字节码的元标识</span><br><span class="line">LOG2 PUSH5 0x6970667358 0x22 SLT KECCAK256 SUB CALLDATACOPY 0xA6 0xD0 0xF8 0xE1 0x2D 0x27 LOG3 PUSH27 0x26E2BECB7FE90EE8E3D86A8970E157D9CB79B1A7FE2B64736F6C63 NUMBER STOP ADDMOD MULMOD STOP CALLER</span><br></pre></td></tr></table></figure>
<p>使用下面的命令可以打印出可读性更好的中间语言代码（但里面有许多 solidity 自定义函数的层层封装，会显得比较多），其与汇编的逻辑是一致的，也可供参考。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">solc --ir test.sol</span><br><span class="line">solc --ir-optimized test.sol</span><br></pre></td></tr></table></figure>
<p>下面命令可以打印合约 storage 的布局。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  test solc --storage-layout test.sol</span><br><span class="line"></span><br><span class="line">======= test.sol:Foo =======</span><br><span class="line">Contract Storage Layout:</span><br><span class="line">&#123;&quot;storage&quot;:[&#123;&quot;astId&quot;:3,&quot;contract&quot;:&quot;test.sol:Foo&quot;,&quot;label&quot;:&quot;x&quot;,&quot;offset&quot;:0,&quot;slot&quot;:&quot;0&quot;,&quot;type&quot;:&quot;t_uint256&quot;&#125;],&quot;types&quot;:&#123;&quot;t_uint256&quot;:&#123;&quot;encoding&quot;:&quot;inplace&quot;,&quot;label&quot;:&quot;uint256&quot;,&quot;numberOfBytes&quot;:&quot;32&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<h1>总结</h1>
<p>通过上面的分析，可以更透彻的理解智能合约部署和调用的底层逻辑。下面是一些总结。</p>
<h2 id="合约部署">合约部署</h2>
<p>从用户角度看，合约部署是向零地址地址发送合约部署代码，注意零地址不是 <code>0x00..</code> 。以太坊角度看， data 作为智能合约代码执行，并将输出结果作为合约代码保存在合约地址上。</p>
<p>以案例分析中的合约为例，可以用 evm 验证。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 生成合约的部署代码</span><br><span class="line">$ solc --bin --optimize test.sol</span><br><span class="line"></span><br><span class="line">======= test.sol:Foo =======</span><br><span class="line">Binary:</span><br><span class="line">608060405234801561001057600080fd5b506040516100d63803806100d683398101604081905261002f91610037565b600055610050565b60006020828403121561004957600080fd5b5051919050565b60788061005e6000396000f3fe6080604052348015600f57600080fd5b506004361060285760003560e01c8063c298557814602d575b600080fd5b60005460405190815260200160405180910390f3fea26469706673582212200337a6d0f8e12d27a37a26e2becb7fe90ee8e3d86a8970e157d9cb79b1a7fe2b64736f6c63430008090033</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在上述输出后添加上 &#x27;00&#x27;*0x20 作为 constructor 的参数。</span><br><span class="line"># 注意这个参数要在 code 的尾部，而不能通过 --input 传递。</span><br><span class="line">$ evm run --code 608060405234801561001057600080fd5b506040516100d63803806100d683398101604081905261002f91610037565b600055610050565b60006020828403121561004957600080fd5b5051919050565b60788061005e6000396000f3fe6080604052348015600f57600080fd5b506004361060285760003560e01c8063c298557814602d575b600080fd5b60005460405190815260200160405180910390f3fea26469706673582212200337a6d0f8e12d27a37a26e2becb7fe90ee8e3d86a8970e157d9cb79b1a7fe2b64736f6c634300080900330000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line"># 输出如下：</span><br><span class="line">0x6080604052348015600f57600080fd5b506004361060285760003560e01c8063c298557814602d575b600080fd5b60005460405190815260200160405180910390f3fea26469706673582212200337a6d0f8e12d27a37a26e2becb7fe90ee8e3d86a8970e157d9cb79b1a7fe2b64736f6c63430008090033</span><br><span class="line"></span><br><span class="line"># 对比可以发现，前面输出确实就是合约的部署后的代码。</span><br><span class="line">$ test solc --bin-runtime --optimize test.sol</span><br><span class="line"></span><br><span class="line">======= test.sol:Foo =======</span><br><span class="line">Binary of the runtime part:</span><br><span class="line">6080604052348015600f57600080fd5b506004361060285760003560e01c8063c298557814602d575b600080fd5b60005460405190815260200160405180910390f3fea26469706673582212200337a6d0f8e12d27a37a26e2becb7fe90ee8e3d86a8970e157d9cb79b1a7fe2b64736f6c63430008090033</span><br></pre></td></tr></table></figure>
<p>可以得到如下结论：</p>
<ul>
<li>
<p>智能合约的 constructor 代码，是在部署时执行的。而执行没结束前，无法取得输出，也就向目标地址部署代码。因此 constructor 执行时，合约地址的 codesize 是 0。这就是许多文章都提到，用 codesize 判断某个地址是不是合约的方法可能存在误判的原因。</p>
</li>
<li>
<p>向地址发送 data 是少有的可以直接执行任意 EVM 代码的地方。正常情况下：</p>
<ul>
<li>向普通账户发送 data，只当作附加信息处理。</li>
<li>向合约账户发送 data，会当作 input 处理。</li>
</ul>
</li>
<li>
<p>以太坊 RPC 接口 <code>eth_call</code> 可在不上链的情况下执行一笔交易。利用这个接口，向 0 地址发送 EVM 代码即可执行任意的 EVM 代码。<strong>某些项目没有注意到这一点，被黑客绕过了检查。</strong></p>
</li>
</ul>
<p>如下是利用 eth.call 方法可以执行任意 VM 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 这段代码的作用是返回 0x000000000000000000000000000000ff</span><br><span class="line">$ evm --input 60ff60005260106010f3 disasm</span><br><span class="line">60ff60005260106010f3</span><br><span class="line">00000: PUSH1 0xff</span><br><span class="line">00002: PUSH1 0x00</span><br><span class="line">00004: MSTORE</span><br><span class="line">00005: PUSH1 0x10</span><br><span class="line">00007: PUSH1 0x10</span><br><span class="line">00009: RETURN</span><br><span class="line"># 执行效果如下：</span><br><span class="line">$ evm --code 0x60ff60005260106010f3 run</span><br><span class="line">0x000000000000000000000000000000ff</span><br></pre></td></tr></table></figure>
<p>相当于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; eth.call(&#123;data:&quot;0x60ff60005260106010f3&quot;&#125;)</span><br><span class="line">&quot;0x000000000000000000000000000000ff&quot;</span><br></pre></td></tr></table></figure>
<h2 id="合约调用">合约调用</h2>
<p>合约调用的交易将 data 作为 input。合约调用的过程也可以用 evm 模拟。</p>
<p><code>--code</code> 为前面部署后的 Foo 合约。 <code>--input</code> 为 <code>foo()</code> 函数所对应的 selector。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ evm --code 6080604052348015600f57600080fd5b506004361060285760003560e01c8063c298557814602d575b600080fd5b60005460405190815260200160405180910390f3fea26469706673582212200337a6d0f8e12d27a37a26e2becb7fe90ee8e3d86a8970e157d9cb79b1a7fe2b64736f6c63430008090033  --input 0xc2985578 run</span><br><span class="line">0x0000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line"># 返回 x 在 storage 中默认的值 0。</span><br></pre></td></tr></table></figure>
<p>注：</p>
<ul>
<li>合约调用时，data 作为 EVM 的 input，使用合约自身的代码作为 code。这时调用方不再有执行任意 EVM 代码的机会。</li>
<li>根据 solidity 的约定，将 input 前 4 字节作为 selector，用来决定要调用的函数。在前面的分析可以看出，合约代码中使用了类似 switch case 的形式判断 selector 来决定跳转到哪个位置执行（即调用哪个函数）。具体来说，<strong>dispatcher 是首先将合约所有的函数签名按照大小排序，然后匹配则是超过一定数量则二分匹配</strong>。而合约只会对 public 函数生成 selector。对于内部函数则不会生成。因此内部函数无论如何是无法调用到的（根据内部函数签名生成一个 selector 去尝试调用显然也是不会成功的。）</li>
<li>对于 EVM 来说其所做的事只是将 data 作为 input 执行 code 而已。这些 ABI 的约定其实完全是 solidity 编译器所决定的。如果开发一个私人的编译器，生成的代码以其他形式处理参数序列化的形式，函数选择的方式，也是可以的。</li>
<li>payable, receive, fallback 这类的语义都是在 solidity 层面才有的，对于 EVM 来说并不存在专门对应的指令。以 payable 为例，某个函数是不是 payable 的，是 solidity 专门生成了 EVM 指令来判断，callvalue 不为 0 时，如果不主动 revert 则相当于是 payable 的。</li>
</ul>
<h1>参考</h1>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://noxx.substack.com/p/evm-deep-dives-the-path-to-shadowy?s=r">EVM Deep Dives: The Path to Shadowy Super Coder</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hacking.app/category/programming-languages/solidity/">https://hacking.app/category/programming-languages/solidity/</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.youtube.com/playlist?list=PLNLh1EyDzSGP-lkNCBhCptoJ-NMu_BYfS">https://www.youtube.com/playlist?list=PLNLh1EyDzSGP-lkNCBhCptoJ-NMu_BYfS</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.writebug.com/explore/article/4gGo52kR">Solidity 字节码 Bytecode 的理解</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.anquanke.com/post/id/224712">智能合约安全系列文章之反编译篇</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://paper.seebug.org/640/">以太坊智能合约 OPCODE 逆向之理论基础篇</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://emn178.github.io/online-tools/keccak_256.html">在线 keecak256 计算</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.soliditylang.org/en/latest/internals/layout_in_memory.html#layout-in-memory">Layout in Memory</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html#layout-of-state-variables-in-storage">Layout of State Variables in Storage</a></li>
<li>Chen, Ting, Zihao Li, Xiapu Luo, Xiaofeng Wang, Ting Wang, Zheyuan He, Kezhao Fang, 等. 《SigRec: Automatic Recovery of Function Signatures in Smart Contracts》. <em>IEEE Transactions on Software Engineering</em>, 2021 年, 1–1. <a target="_blank" rel="noopener external nofollow noreferrer" href="https://doi.org/10.1109/TSE.2021.3078342">https://doi.org/10.1109/TSE.2021.3078342</a>.</li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://recon.cx/2018/montreal/schedule/system/event_attachments/attachments/000/000/053/original/RECON-MTL-2018-Reversing_blockchains_smart_contracts.pdf">https://recon.cx/2018/montreal/schedule/system/event_attachments/attachments/000/000/053/original/RECON-MTL-2018-Reversing_blockchains_smart_contracts.pdf</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s/UWU1nuZaGOM0_IHd5AhyvA">https://mp.weixin.qq.com/s/UWU1nuZaGOM0_IHd5AhyvA</a></li>
</ul>
<h1>附录 I 工具介绍</h1>
<p>为了方便读者深入学习，这里简短介绍字节码分析的相关工具。</p>
<p>**一、**Remix IDE 请自行阅读官方文档。</p>
<p><strong>二、</strong><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ethereum/go-ethereum">go-ethereum</a> 项目官网有工具介绍，这里会较常用字节码调试工具 <code>evm</code>。下面是参数介绍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">evm [global options] command [command options] [arguments...]</span><br><span class="line"></span><br><span class="line">VERSION:</span><br><span class="line">   1.10.17-stable-25c9b49f</span><br><span class="line"></span><br><span class="line">COMMANDS:</span><br><span class="line">   compile                            compiles easm source to evm binary //evm 抽象语法树，已经废弃</span><br><span class="line">   disasm                             disassembles evm binary //字节码生成操作码</span><br><span class="line">   run                                run arbitrary evm binary //运行字节码，预期的下一个参数是一串16进制字节码，而不是文件</span><br><span class="line">   statetest                          executes the given state tests //不清楚它检查状态输入是什么</span><br><span class="line">   transition                         executes a full state transition //不清楚状态转移的工具是什么</span><br><span class="line">   transaction                        performs transaction validation</span><br><span class="line">   block-builder                      builds a block</span><br><span class="line">   help                               Shows a list of commands or help for one command</span><br><span class="line"></span><br><span class="line">GLOBAL OPTIONS:</span><br><span class="line">   --bench                            benchmark the execution //基准测试</span><br><span class="line">   --create                           indicates the action should be create rather than call</span><br><span class="line">   --debug                            output full trace logs //跟踪执行堆栈、存储</span><br><span class="line">   --verbosity value                  sets the verbosity level (default: 0)</span><br><span class="line">   --code value                       EVM code //直接在命令行中以字节码为参数</span><br><span class="line">   --codefile value                   File containing EVM code. If &#x27;-&#x27; is specified, code is read from stdin //从文件在寻找输入</span><br><span class="line">   --gas value                        gas limit for the evm (default: 10000000000)</span><br><span class="line">   --price value                      price set for the evm (default: 0)</span><br><span class="line">   --value value                      value set for the evm (default: 0)</span><br><span class="line">   --dump                             dumps the state after the run</span><br><span class="line">   --input value                      input for the EVM //部署时的构造函数参数</span><br><span class="line">   --inputfile value                  file containing input for the EVM //从文件中读取构造函数参数</span><br><span class="line">   --memprofile value                 creates a memory profile at the given path</span><br><span class="line">   --cpuprofile value                 creates a CPU profile at the given path</span><br><span class="line">   --statdump                         displays stack and heap memory information</span><br><span class="line">   --prestate value                   JSON file with prestate (genesis) config</span><br><span class="line">   --json                             output trace logs in machine readable format (json)</span><br><span class="line">   --sender value                     The transaction origin</span><br><span class="line">   --receiver value                   The transaction receiver (execution context)</span><br><span class="line">   --nomemory                         disable memory output</span><br><span class="line">   --nostack                          disable stack output</span><br><span class="line">   --nostorage                        disable storage output</span><br><span class="line">   --noreturndata                     enable return data output</span><br><span class="line">   --help, -h                         show help</span><br><span class="line">   --version, -v                      print the version</span><br></pre></td></tr></table></figure>
<p>可以参考我在 stackexchange 中的<a target="_blank" rel="noopener external nofollow noreferrer" href="https://ethereum.stackexchange.com/questions/68650/how-to-use-the-evm-command-of-go-ethereum/127185#127185">回答</a>，简单的使用方法就不赘述了。根据官方源码中的<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ethereum/go-ethereum/tree/master/cmd/evm">介绍</a>，实际上它更新了许多新东西。简单地说是一个调试 evm 的工具，可以指定 fork 分叉，也可以自定义区块高度。然后自定义初始账户在 alloc 里，可以自定义交易在 txt 里，自定义链配置在 env 里，然后输出 storageroot、执行后的账户状态、交易 RLP 编码、堆栈跟踪结果等。</p>
<p>**三、**字节码逆向。我一般使用这两个网站 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://ethervm.io/decompile">Online Solidity Decompiler</a>、<a target="_blank" rel="noopener external nofollow noreferrer" href="https://library.dedaub.com/contracts/hottest">dedaub</a>。</p>
<img src="https://cdn.blog-blockchain.xyz/202205050943137.png" alt="image-20220505094351757" style="zoom:50%;" />
<p>逆向后的伪代码的抽象程度较高，能够辅助分析字节码。其中 dedaub 全部用十进制表示数，会让人忽视内在的设计思路，不是很推荐。</p>
<p>**四、**我也尝试过使用 truffle 的调试器，感觉还可以，和 remix ide 差不多。它还推出了 vscode 插件，但是功能不如命令行的好用。感兴趣可阅读<a target="_blank" rel="noopener external nofollow noreferrer" href="https://trufflesuite.com/docs/vscode-ext/installation-guide/">插件安装</a>和<a target="_blank" rel="noopener external nofollow noreferrer" href="https://trufflesuite.com/docs/truffle/getting-started/using-the-truffle-debugger/">调试教程</a>。</p>
<p>**五、**JEB 也有合约逆向工具，主要用法是，打开项目时字节码文件的后缀是 <code>evm-bytecode</code>。进入项目后在左下角找到如下图的这一行，然后右键选择 Decompile。具体可见<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.pnfsoftware.com/jeb/manual/ethereum/">官方手册</a>。它的类型推断做的不好，但是这也是目前的难点。</p>
<p><img src="https://cdn.blog-blockchain.xyz/202205112122886.png" alt="image-20220511212202708" style="zoom:50%;" /><img src="https://cdn.blog-blockchain.xyz/202205112123418.png" alt="image-20220511212315319" style="zoom:50%;" /></p>
<p><strong>六、</strong><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/pventuzelo/octopus">Octopus</a>由于内存布局的方式改变了，已经不能用这，作者还折腾了很久…总之，目前没有找到好用的能够显示字节码数据流图的工具。</p>
<p>**七、**笔者尝试了 IDA, JEB, Binary Ninja 等工具后，发现要么缺少这方面功能，要么很久没维护，过时了。笔者能力足够时，将会自己编写一个显示字节码中数据流图的工具，欢迎感兴趣的朋友一同完成。</p>
<h1>附录 II EVM Tracer</h1>
<h2 id="a-静态类型的跟踪堆栈">a 静态类型的跟踪堆栈</h2>
<p>执行的命令为 <code>evm --codefile BYTECODE_FILE --debug --statdump run</code>，代码过长，以 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://gist.github.com/learnerLj/79f80b10a3388b1728593b9a03acda3e">gist 链接</a>附上。</p>
<h2 id="b-storage-合约的-sloc-汇编">b storage 合约的 sloc 汇编</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br></pre></td><td class="code"><pre><span class="line">EVM assembly:</span><br><span class="line">    /* &quot;function.sol&quot;:70:270  contract Storage &#123;... */</span><br><span class="line">  mstore(0x40, 0x80)</span><br><span class="line">  callvalue</span><br><span class="line">  dup1</span><br><span class="line">  iszero</span><br><span class="line">  tag_1 //如果栈顶元素是1，那么就跳转</span><br><span class="line">  jumpi</span><br><span class="line">  0x00</span><br><span class="line">  dup1</span><br><span class="line">  revert</span><br><span class="line">tag_1:</span><br><span class="line">  pop</span><br><span class="line">  dataSize(sub_0)//运行时字节码大小，关键逻辑在这里</span><br><span class="line">  dup1</span><br><span class="line">  dataOffset(sub_0)//写入区块链是，部署时字节码的偏移量</span><br><span class="line">  0x00</span><br><span class="line">  codecopy</span><br><span class="line">  0x00</span><br><span class="line">  return</span><br><span class="line">stop</span><br><span class="line"></span><br><span class="line">sub_0: assembly &#123; //这是调用函数时的入口</span><br><span class="line">        /* &quot;function.sol&quot;:70:270  contract Storage &#123;... */</span><br><span class="line">      mstore(0x40, 0x80)</span><br><span class="line">      callvalue</span><br><span class="line">      dup1</span><br><span class="line">      iszero</span><br><span class="line">      tag_1//入口</span><br><span class="line">      jumpi</span><br><span class="line">      0x00</span><br><span class="line">      dup1</span><br><span class="line">      revert</span><br><span class="line">    tag_1:</span><br><span class="line">      pop</span><br><span class="line">      jumpi(tag_2, lt(calldatasize, 0x04))//如果calldata小于4字节，那么跳转到tag回滚</span><br><span class="line">      shr(0xe0, calldataload(0x00))</span><br><span class="line">      dup1</span><br><span class="line">      0x2e64cec1</span><br><span class="line">      eq</span><br><span class="line">      tag_3//匹配 retrive签名</span><br><span class="line">      jumpi</span><br><span class="line">      dup1</span><br><span class="line">      0x6057361d</span><br><span class="line">      eq</span><br><span class="line">      tag_4//匹配store签名</span><br><span class="line">      jumpi</span><br><span class="line">    tag_2:</span><br><span class="line">      0x00</span><br><span class="line">      dup1</span><br><span class="line">      revert</span><br><span class="line">        /* &quot;function.sol&quot;:189:268  function retrieve() public view returns (uint256)&#123;... */</span><br><span class="line">    tag_3:</span><br><span class="line">      tag_5</span><br><span class="line">      tag_6</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_5:</span><br><span class="line">      mload(0x40)</span><br><span class="line">      tag_7</span><br><span class="line">      swap2</span><br><span class="line">      swap1</span><br><span class="line">      tag_8</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_7:</span><br><span class="line">      mload(0x40)</span><br><span class="line">      dup1</span><br><span class="line">      swap2</span><br><span class="line">      sub</span><br><span class="line">      swap1</span><br><span class="line">      return</span><br><span class="line">        /* &quot;function.sol&quot;:119:183  function store(uint256 num) public &#123;... */</span><br><span class="line">    tag_4:</span><br><span class="line">      tag_9</span><br><span class="line">      0x04</span><br><span class="line">      dup1</span><br><span class="line">      calldatasize</span><br><span class="line">      sub</span><br><span class="line">      dup2</span><br><span class="line">      add</span><br><span class="line">      swap1</span><br><span class="line">      tag_10</span><br><span class="line">      swap2</span><br><span class="line">      swap1</span><br><span class="line">      tag_11</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_10:</span><br><span class="line">      tag_12</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_9:</span><br><span class="line">      stop</span><br><span class="line">        /* &quot;function.sol&quot;:189:268  function retrieve() public view returns (uint256)&#123;... */</span><br><span class="line">    tag_6:</span><br><span class="line">        /* &quot;function.sol&quot;:230:237  uint256 */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;function.sol&quot;:255:261  number */</span><br><span class="line">      dup1</span><br><span class="line">      sload</span><br><span class="line">        /* &quot;function.sol&quot;:248:261  return number */</span><br><span class="line">      swap1</span><br><span class="line">      pop</span><br><span class="line">        /* &quot;function.sol&quot;:189:268  function retrieve() public view returns (uint256)&#123;... */</span><br><span class="line">      swap1</span><br><span class="line">      jump      // out</span><br><span class="line">        /* &quot;function.sol&quot;:119:183  function store(uint256 num) public &#123;... */</span><br><span class="line">    tag_12:</span><br><span class="line">        /* &quot;function.sol&quot;:173:176  num */</span><br><span class="line">      dup1</span><br><span class="line">        /* &quot;function.sol&quot;:164:170  number */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;function.sol&quot;:164:176  number = num */</span><br><span class="line">      dup2</span><br><span class="line">      swap1</span><br><span class="line">      sstore</span><br><span class="line">      pop</span><br><span class="line">        /* &quot;function.sol&quot;:119:183  function store(uint256 num) public &#123;... */</span><br><span class="line">      pop</span><br><span class="line">      jump      // out</span><br><span class="line">        /* &quot;#utility.yul&quot;:7:84   */</span><br><span class="line">    tag_15:</span><br><span class="line">        /* &quot;#utility.yul&quot;:44:51   */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;#utility.yul&quot;:73:78   */</span><br><span class="line">      dup2</span><br><span class="line">        /* &quot;#utility.yul&quot;:62:78   */</span><br><span class="line">      swap1</span><br><span class="line">      pop</span><br><span class="line">        /* &quot;#utility.yul&quot;:7:84   */</span><br><span class="line">      swap2</span><br><span class="line">      swap1</span><br><span class="line">      pop</span><br><span class="line">      jump      // out</span><br><span class="line">        /* &quot;#utility.yul&quot;:90:208   */</span><br><span class="line">    tag_16:</span><br><span class="line">        /* &quot;#utility.yul&quot;:177:201   */</span><br><span class="line">      tag_25</span><br><span class="line">        /* &quot;#utility.yul&quot;:195:200   */</span><br><span class="line">      dup2</span><br><span class="line">        /* &quot;#utility.yul&quot;:177:201   */</span><br><span class="line">      tag_15</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_25:</span><br><span class="line">        /* &quot;#utility.yul&quot;:172:175   */</span><br><span class="line">      dup3</span><br><span class="line">        /* &quot;#utility.yul&quot;:165:202   */</span><br><span class="line">      mstore</span><br><span class="line">        /* &quot;#utility.yul&quot;:90:208   */</span><br><span class="line">      pop</span><br><span class="line">      pop</span><br><span class="line">      jump      // out</span><br><span class="line">        /* &quot;#utility.yul&quot;:214:436   */</span><br><span class="line">    tag_8:</span><br><span class="line">        /* &quot;#utility.yul&quot;:307:311   */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;#utility.yul&quot;:345:347   */</span><br><span class="line">      0x20</span><br><span class="line">        /* &quot;#utility.yul&quot;:334:343   */</span><br><span class="line">      dup3</span><br><span class="line">        /* &quot;#utility.yul&quot;:330:348   */</span><br><span class="line">      add</span><br><span class="line">        /* &quot;#utility.yul&quot;:322:348   */</span><br><span class="line">      swap1</span><br><span class="line">      pop</span><br><span class="line">        /* &quot;#utility.yul&quot;:358:429   */</span><br><span class="line">      tag_27</span><br><span class="line">        /* &quot;#utility.yul&quot;:426:427   */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;#utility.yul&quot;:415:424   */</span><br><span class="line">      dup4</span><br><span class="line">        /* &quot;#utility.yul&quot;:411:428   */</span><br><span class="line">      add</span><br><span class="line">        /* &quot;#utility.yul&quot;:402:408   */</span><br><span class="line">      dup5</span><br><span class="line">        /* &quot;#utility.yul&quot;:358:429   */</span><br><span class="line">      tag_16</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_27:</span><br><span class="line">        /* &quot;#utility.yul&quot;:214:436   */</span><br><span class="line">      swap3</span><br><span class="line">      swap2</span><br><span class="line">      pop</span><br><span class="line">      pop</span><br><span class="line">      jump      // out</span><br><span class="line">        /* &quot;#utility.yul&quot;:523:640   */</span><br><span class="line">    tag_18:</span><br><span class="line">        /* &quot;#utility.yul&quot;:632:633   */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;#utility.yul&quot;:629:630   */</span><br><span class="line">      dup1</span><br><span class="line">        /* &quot;#utility.yul&quot;:622:634   */</span><br><span class="line">      revert</span><br><span class="line">        /* &quot;#utility.yul&quot;:769:891   */</span><br><span class="line">    tag_20:</span><br><span class="line">        /* &quot;#utility.yul&quot;:842:866   */</span><br><span class="line">      tag_32</span><br><span class="line">        /* &quot;#utility.yul&quot;:860:865   */</span><br><span class="line">      dup2</span><br><span class="line">        /* &quot;#utility.yul&quot;:842:866   */</span><br><span class="line">      tag_15</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_32:</span><br><span class="line">        /* &quot;#utility.yul&quot;:835:840   */</span><br><span class="line">      dup2</span><br><span class="line">        /* &quot;#utility.yul&quot;:832:867   */</span><br><span class="line">      eq</span><br><span class="line">        /* &quot;#utility.yul&quot;:822:885   */</span><br><span class="line">      tag_33</span><br><span class="line">      jumpi</span><br><span class="line">        /* &quot;#utility.yul&quot;:881:882   */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;#utility.yul&quot;:878:879   */</span><br><span class="line">      dup1</span><br><span class="line">        /* &quot;#utility.yul&quot;:871:883   */</span><br><span class="line">      revert</span><br><span class="line">        /* &quot;#utility.yul&quot;:822:885   */</span><br><span class="line">    tag_33:</span><br><span class="line">        /* &quot;#utility.yul&quot;:769:891   */</span><br><span class="line">      pop</span><br><span class="line">      jump      // out</span><br><span class="line">        /* &quot;#utility.yul&quot;:897:1036   */</span><br><span class="line">    tag_21:</span><br><span class="line">        /* &quot;#utility.yul&quot;:943:948   */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;#utility.yul&quot;:981:987   */</span><br><span class="line">      dup2</span><br><span class="line">        /* &quot;#utility.yul&quot;:968:988   */</span><br><span class="line">      calldataload</span><br><span class="line">        /* &quot;#utility.yul&quot;:959:988   */</span><br><span class="line">      swap1</span><br><span class="line">      pop</span><br><span class="line">        /* &quot;#utility.yul&quot;:997:1030   */</span><br><span class="line">      tag_35</span><br><span class="line">        /* &quot;#utility.yul&quot;:1024:1029   */</span><br><span class="line">      dup2</span><br><span class="line">        /* &quot;#utility.yul&quot;:997:1030   */</span><br><span class="line">      tag_20</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_35:</span><br><span class="line">        /* &quot;#utility.yul&quot;:897:1036   */</span><br><span class="line">      swap3</span><br><span class="line">      swap2</span><br><span class="line">      pop</span><br><span class="line">      pop</span><br><span class="line">      jump      // out</span><br><span class="line">        /* &quot;#utility.yul&quot;:1042:1371   */</span><br><span class="line">    tag_11:</span><br><span class="line">        /* &quot;#utility.yul&quot;:1101:1107   */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;#utility.yul&quot;:1150:1152   */</span><br><span class="line">      0x20</span><br><span class="line">        /* &quot;#utility.yul&quot;:1138:1147   */</span><br><span class="line">      dup3</span><br><span class="line">        /* &quot;#utility.yul&quot;:1129:1136   */</span><br><span class="line">      dup5</span><br><span class="line">        /* &quot;#utility.yul&quot;:1125:1148   */</span><br><span class="line">      sub</span><br><span class="line">        /* &quot;#utility.yul&quot;:1121:1153   */</span><br><span class="line">      slt</span><br><span class="line">        /* &quot;#utility.yul&quot;:1118:1237   */</span><br><span class="line">      iszero</span><br><span class="line">      tag_37</span><br><span class="line">      jumpi</span><br><span class="line">        /* &quot;#utility.yul&quot;:1156:1235   */</span><br><span class="line">      tag_38</span><br><span class="line">      tag_18</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_38:</span><br><span class="line">        /* &quot;#utility.yul&quot;:1118:1237   */</span><br><span class="line">    tag_37:</span><br><span class="line">        /* &quot;#utility.yul&quot;:1276:1277   */</span><br><span class="line">      0x00</span><br><span class="line">        /* &quot;#utility.yul&quot;:1301:1354   */</span><br><span class="line">      tag_39</span><br><span class="line">        /* &quot;#utility.yul&quot;:1346:1353   */</span><br><span class="line">      dup5</span><br><span class="line">        /* &quot;#utility.yul&quot;:1337:1343   */</span><br><span class="line">      dup3</span><br><span class="line">        /* &quot;#utility.yul&quot;:1326:1335   */</span><br><span class="line">      dup6</span><br><span class="line">        /* &quot;#utility.yul&quot;:1322:1344   */</span><br><span class="line">      add</span><br><span class="line">        /* &quot;#utility.yul&quot;:1301:1354   */</span><br><span class="line">      tag_21</span><br><span class="line">      jump      // in</span><br><span class="line">    tag_39:</span><br><span class="line">        /* &quot;#utility.yul&quot;:1291:1354   */</span><br><span class="line">      swap2</span><br><span class="line">      pop</span><br><span class="line">        /* &quot;#utility.yul&quot;:1247:1364   */</span><br><span class="line">      pop</span><br><span class="line">        /* &quot;#utility.yul&quot;:1042:1371   */</span><br><span class="line">      swap3</span><br><span class="line">      swap2</span><br><span class="line">      pop</span><br><span class="line">      pop</span><br><span class="line">      jump      // out</span><br><span class="line"></span><br><span class="line">    auxdata: 0xa26469706673582212202171984ccb0a85eea6b8ddfdd3927496135929d4d68bc35c2a03ee376ced497564736f6c634300080a0033</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://www.blog-blockchain.xyz">Michael(Jiahao) Luo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://www.blog-blockchain.xyz/evm/evm-basic-bytecode/">https://www.blog-blockchain.xyz/evm/evm-basic-bytecode/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/evm/">evm</a></div><div class="post-share"><div class="social-share" data-image="/images/evm-bytecode.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/evm/state-variable/" title="（二）状态变量的赋值"><img class="cover" src="/images/evm-bytecode.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">（二）状态变量的赋值</div></div><div class="info-2"><div class="info-item-1"> （一）初步认识EVM字节码（二）状态变量的赋值（三）函数调用  状态变量的字节码 对于最简单的情况，我们观察它部署时的情况 123456// SPDX-License-Identifier: GPL-3.0pragma solidity &gt;=0.7.0 &lt;0.9.0;contract Empty&#123;    uint a;&#125; EVM 汇编如下 1234567891011121314151617181920212223242526272829303132======= Empty.sol:Empty =======EVM assembly:    /* &quot;Empty.sol&quot;:69:95  contract Empty&#123;... */  mstore(0x40, 0x80)  callvalue  dup1  iszero  tag_1  jumpi  0x00  dup1  reverttag_1:  pop  dataSize(sub_0)  dup1  dataOffset(sub_0)  0x00 ...</div></div></div></a><a class="pagination-related" href="/evm/principle-and-disign-of-evm/" title="EVM的设计与原理"><img class="cover" src="/images/evm.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">EVM的设计与原理</div></div><div class="info-2"><div class="info-item-1"> 初步理解以太坊虚拟机以太坊的数据组织EVM的设计与原理  前言 在阅读这篇文章之前，请您先阅读初步理解以太坊虚拟机和以太坊的数据组织，它将会介绍 EVM 的基本知识，帮助您形成基本的认识。在开始之前，假设您已经掌握了上文中的基础，我们根据黄皮书进一步地补充理论基础。由于原始的黄皮书公式过多，不易阅读，可以参考按照论文重写后的版本。其次，本文使用的图片来自其他资料，会在参考资料部分注明。 非常推荐读者观看这个视频：EVM: From Solidity to byte code, memory and storage ，这是配套的 PDF。 它梳理源码到字节码的流程，演示操作码的变化，非常棒。如果读者通过前面提到的文章以及理解 EVM 的存储空间布局的话，这个视频可以为您提供字节码编写合约的基础:smirk_cat:.请善用 Remix IDE 的单步调试功能，可以通过实操，大大加深理解。 EVM 设计原理 以太坊可以抽象的分成两部分，一部分是状态，另外一部分是用于改变状态的...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/evm/basic-understanding-to-evm/" title="初步理解以太坊虚拟机"><img class="cover" src="/images/evm.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-23</div><div class="info-item-2">初步理解以太坊虚拟机</div></div><div class="info-2"><div class="info-item-1"> 初步理解以太坊虚拟机以太坊的数据组织EVM的设计与原理  体系结构  存储层 一般的客户端采用 LevelDB 数据库，而 OpenEthereum 采用了 RocksDB。LevelDB 是 Key-Value 的、基于 Log-Structured Merge Tree 的非关系数据库。例如 geth 的所有区块数据都是存储在 LevelDB 中，而 LevelDB 的实现在源代码的 ethdb 包内。 数据层 以太坊的数据层主要定义了数据结构、数据模型、哈希函数、签名算法等。以太坊采用独特的数据结构保护区块头和区块体，区块头含有交易的 Merkle 根哈希值，还有账户状态的 Merkle 根哈希值、日志的 Merkle 根哈希值。以太坊中 Merkle 根哈希值是采用 Merkle Patricia Tree 计算的。哈希函数使用 keccak256，数字签名采用 ECDSA。 网络层 以太坊节点通信采用的 p2p 协议是 DEVp2p，包含了 RLPx、Discv4 等子协议。RLPx 是安全的数据传输协议，采用 ECIES(Elliptic Curve...</div></div></div></a><a class="pagination-related" href="/evm/data-layout/" title="以太坊的数据组织"><img class="cover" src="/images/evm.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-23</div><div class="info-item-2">以太坊的数据组织</div></div><div class="info-2"><div class="info-item-1"> 初步理解以太坊虚拟机以太坊的数据组织EVM的设计与原理  这篇文章主要介绍以太坊的数据组织形式，构建以太坊各部分数据结构是如何组织的系统观。随后，我将会选取黄皮书中的核心设计思想，写得相对通俗易懂。各部分具体的数据结构，将会在后续的源码解读中给出。 概览 以太坊的区块由区块头和区块体构成，区块头存储元数据，通过区块哈希形成链式结构。区块体用于存储交易的集合和其他数据，大致结构如下：  Trie Tree Trie Tree 被称作字典树，或者 前缀树 (prefix Tree)，用于管理键值对类型的多叉树。字典树的 Key 不是直接保存在某一个节点，而是通过节点在树中的位置确定，类似于哈夫曼编码树。因此，可知子节点都有相同的前缀。只有叶子节点才存放 Value，从根节点到叶子节点形成的路径上的节点，按照顺序排列构成 Value 的 Key.  假如 节点 d 存储 Value，则 and 是它的 Key 总体如下：  根节点不包含字符，根节点外的所有节点都只包含一个字符。 从根节点到某个节点，路径上经过的的字符连起来，为该节点对应的 Key. 每个节点的 Key...</div></div></div></a><a class="pagination-related" href="/evm/state-variable/" title="（二）状态变量的赋值"><img class="cover" src="/images/evm-bytecode.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-24</div><div class="info-item-2">（二）状态变量的赋值</div></div><div class="info-2"><div class="info-item-1"> （一）初步认识EVM字节码（二）状态变量的赋值（三）函数调用  状态变量的字节码 对于最简单的情况，我们观察它部署时的情况 123456// SPDX-License-Identifier: GPL-3.0pragma solidity &gt;=0.7.0 &lt;0.9.0;contract Empty&#123;    uint a;&#125; EVM 汇编如下 1234567891011121314151617181920212223242526272829303132======= Empty.sol:Empty =======EVM assembly:    /* &quot;Empty.sol&quot;:69:95  contract Empty&#123;... */  mstore(0x40, 0x80)  callvalue  dup1  iszero  tag_1  jumpi  0x00  dup1  reverttag_1:  pop  dataSize(sub_0)  dup1  dataOffset(sub_0)  0x00 ...</div></div></div></a><a class="pagination-related" href="/evm/principle-and-disign-of-evm/" title="EVM的设计与原理"><img class="cover" src="/images/evm.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-23</div><div class="info-item-2">EVM的设计与原理</div></div><div class="info-2"><div class="info-item-1"> 初步理解以太坊虚拟机以太坊的数据组织EVM的设计与原理  前言 在阅读这篇文章之前，请您先阅读初步理解以太坊虚拟机和以太坊的数据组织，它将会介绍 EVM 的基本知识，帮助您形成基本的认识。在开始之前，假设您已经掌握了上文中的基础，我们根据黄皮书进一步地补充理论基础。由于原始的黄皮书公式过多，不易阅读，可以参考按照论文重写后的版本。其次，本文使用的图片来自其他资料，会在参考资料部分注明。 非常推荐读者观看这个视频：EVM: From Solidity to byte code, memory and storage ，这是配套的 PDF。 它梳理源码到字节码的流程，演示操作码的变化，非常棒。如果读者通过前面提到的文章以及理解 EVM 的存储空间布局的话，这个视频可以为您提供字节码编写合约的基础:smirk_cat:.请善用 Remix IDE 的单步调试功能，可以通过实操，大大加深理解。 EVM 设计原理 以太坊可以抽象的分成两部分，一部分是状态，另外一部分是用于改变状态的...</div></div></div></a><a class="pagination-related" href="/evm/function-call/" title="（三）函数调用"><img class="cover" src="/images/evm-bytecode.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-24</div><div class="info-item-2">（三）函数调用</div></div><div class="info-2"><div class="info-item-1"> （一）初步认识EVM字节码（二）状态变量的赋值（三）函数调用  普通函数调用 简单赋值 注意：需要区分部署时和运行时字节码，参考下面这张图。虽然现在的字节码有小改动，但是仍然有参考意义。  所以在编译成字节码是应该使用 solc --bin-runtime FILE_NAME 12345678910111213141516// SPDX-License-Identifier: GPL-3.0pragma solidity &gt;=0.7.0 &lt;0.9.0;contract Storage &#123;    uint256 number;    function store(uint256 num) public &#123;        number = num;    &#125;    function retrieve() public view returns (uint256)&#123;        return number;    &#125;&#125; 我们在部署时字节码正常的流程中是看不到函数的调用流程的。虽然 solc 产生的汇编使用...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/site-avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Michael(Jiahao) Luo</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">80</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/LearnerLj"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://www.linkedin.com/in/jiahao-michael-luo-8ba5942a3" rel="external nofollow noreferrer" target="_blank" title="Linkedin"><i class="fa-brands fa-linkedin"></i></a><a class="social-icon" href="https://x.com/jiahao_luo9" rel="external nofollow noreferrer" target="_blank" title="Twitter"><i class="fa-brands fa-twitter"></i></a><a class="social-icon" href="https://github.com/learnerLj" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:luoshitou9@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS链接"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">从技术到商业，从产品到设计，从生活到未来，我会在这里分享我的所思所想，欢迎关注！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">合约创建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%92%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">2.1.</span> <span class="toc-text">字节码和运行时字节码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EVM-%E6%B1%87%E7%BC%96"><span class="toc-number">2.2.</span> <span class="toc-text">EVM 汇编</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#calldata"><span class="toc-number">2.3.</span> <span class="toc-text">calldata</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">案例分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E7%BA%A6%E9%83%A8%E7%BD%B2"><span class="toc-number">4.1.</span> <span class="toc-text">合约部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E7%BA%A6%E8%B0%83%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">合约调用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">附录 I 工具介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">附录 II EVM Tracer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#a-%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%B7%9F%E8%B8%AA%E5%A0%86%E6%A0%88"><span class="toc-number">7.1.</span> <span class="toc-text">a 静态类型的跟踪堆栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#b-storage-%E5%90%88%E7%BA%A6%E7%9A%84-sloc-%E6%B1%87%E7%BC%96"><span class="toc-number">7.2.</span> <span class="toc-text">b storage 合约的 sloc 汇编</span></a></li></ol></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>Post Series</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/evm/evm-basic-bytecode/" title="（一）初步认识EVM字节码"><img src="/images/evm-bytecode.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="（一）初步认识EVM字节码"></a><div class="content"><a class="title" href="/evm/evm-basic-bytecode/" title="（一）初步认识EVM字节码">（一）初步认识EVM字节码</a><time datetime="2022-08-24T10:29:33.000Z" title="Created 2022-08-24 18:29:33">2022-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/evm/state-variable/" title="（二）状态变量的赋值"><img src="/images/evm-bytecode.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="（二）状态变量的赋值"></a><div class="content"><a class="title" href="/evm/state-variable/" title="（二）状态变量的赋值">（二）状态变量的赋值</a><time datetime="2022-08-24T11:29:33.000Z" title="Created 2022-08-24 19:29:33">2022-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/evm/function-call/" title="（三）函数调用"><img src="/images/evm-bytecode.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="（三）函数调用"></a><div class="content"><a class="title" href="/evm/function-call/" title="（三）函数调用">（三）函数调用</a><time datetime="2022-08-24T11:30:33.000Z" title="Created 2022-08-24 19:30:33">2022-08-24</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/dev/rust-lifetime/" title="深入学习Rust生命周期"><img src="https://cdn.blog-blockchain.xyz/2025/03/7a1eb877711a4e78b90307ccefde92f4.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入学习Rust生命周期"/></a><div class="content"><a class="title" href="/dev/rust-lifetime/" title="深入学习Rust生命周期">深入学习Rust生命周期</a><time datetime="2025-03-28T10:58:20.000Z" title="Created 2025-03-28 18:58:20">2025-03-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/dev/study-mini-redis/" title="深入学习Rust异步编程：mini-redis项目解析"><img src="https://cdn.blog-blockchain.xyz/2025/03/7a1eb877711a4e78b90307ccefde92f4.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入学习Rust异步编程：mini-redis项目解析"/></a><div class="content"><a class="title" href="/dev/study-mini-redis/" title="深入学习Rust异步编程：mini-redis项目解析">深入学习Rust异步编程：mini-redis项目解析</a><time datetime="2025-03-22T20:33:20.000Z" title="Created 2025-03-23 04:33:20">2025-03-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/dev/value-of-software-engineering/" title="程序员的价值在哪里"><img src="https://cdn.blog-blockchain.xyz/2025/03/743b33dee5c8b2089f9483cdf2067b25.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="程序员的价值在哪里"/></a><div class="content"><a class="title" href="/dev/value-of-software-engineering/" title="程序员的价值在哪里">程序员的价值在哪里</a><time datetime="2025-03-09T18:01:20.000Z" title="Created 2025-03-10 02:01:20">2025-03-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/career/crypto-beyond-alpha-and-manipulation/" title="从 Alpha 到坐庄：不充分市场中的暴富"><img src="https://cdn.blog-blockchain.xyz/2025/02/7c227b9f1d763dfd7bb44bc6f10b35b6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从 Alpha 到坐庄：不充分市场中的暴富"/></a><div class="content"><a class="title" href="/career/crypto-beyond-alpha-and-manipulation/" title="从 Alpha 到坐庄：不充分市场中的暴富">从 Alpha 到坐庄：不充分市场中的暴富</a><time datetime="2025-02-26T03:11:20.000Z" title="Created 2025-02-26 11:11:20">2025-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/audit/blockchain-client-security/" title="公链安全开发指南和审计checklist"><img src="https://cdn.blog-blockchain.xyz/2025/01/c037c1551777613437e750a0fdd9489c.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="公链安全开发指南和审计checklist"/></a><div class="content"><a class="title" href="/audit/blockchain-client-security/" title="公链安全开发指南和审计checklist">公链安全开发指南和审计checklist</a><time datetime="2025-01-21T09:03:53.000Z" title="Created 2025-01-21 17:03:53">2025-01-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Michael(Jiahao) Luo</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.3.5"></script><script src="/js/main.js?v=5.3.5"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css')
    if (false) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: '467d9506710fff22dc33',
      clientSecret: '2a3e530b895af9c94d4bbe95fe78c69317f4d76e',
      repo: 'blog-gitalk',
      owner: 'learnerLj',
      admin: ['learnerLj'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || 'e5577822826cadd8fd6ea9bbf0412464'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.3.5"></script></div></div></body></html>
<!DOCTYPE html><html lang="default" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>æ·±å…¥å­¦ä¹ Rustå¼‚æ­¥ç¼–ç¨‹ï¼šmini-redisé¡¹ç›®è§£æ | Jiahao Luo</title><meta name="author" content="Michael(Jiahao) Luo"><meta name="copyright" content="Michael(Jiahao) Luo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="description" content="é€šè¿‡æ·±å…¥åˆ†æmini-redisé¡¹ç›®å­¦ä¹ Rustå¼‚æ­¥ç¼–ç¨‹å’Œtokioè¿è¡Œæ—¶ï¼Œæ¶µç›–é¡¹ç›®æ¶æ„è®¾è®¡ã€Redisåè®®å®ç°ã€è¿æ¥ç®¡ç†ã€æ•°æ®åº“æ¨¡å—ç­‰æ ¸å¿ƒç»„ä»¶ï¼Œä»¥åŠæµ‹è¯•å’Œå‘½ä»¤è¡Œå·¥å…·å¼€å‘å®è·µã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="æ·±å…¥å­¦ä¹ Rustå¼‚æ­¥ç¼–ç¨‹ï¼šmini-redisé¡¹ç›®è§£æ">
<meta property="og:url" content="https://www.blog-blockchain.xyz/dev/study-mini-redis/index.html">
<meta property="og:site_name" content="Jiahao Luo">
<meta property="og:description" content="é€šè¿‡æ·±å…¥åˆ†æmini-redisé¡¹ç›®å­¦ä¹ Rustå¼‚æ­¥ç¼–ç¨‹å’Œtokioè¿è¡Œæ—¶ï¼Œæ¶µç›–é¡¹ç›®æ¶æ„è®¾è®¡ã€Redisåè®®å®ç°ã€è¿æ¥ç®¡ç†ã€æ•°æ®åº“æ¨¡å—ç­‰æ ¸å¿ƒç»„ä»¶ï¼Œä»¥åŠæµ‹è¯•å’Œå‘½ä»¤è¡Œå·¥å…·å¼€å‘å®è·µã€‚">
<meta property="og:locale">
<meta property="og:image" content="https://cdn.blog-blockchain.xyz/2025/03/7a1eb877711a4e78b90307ccefde92f4.png">
<meta property="article:published_time" content="2025-03-22T20:33:20.000Z">
<meta property="article:modified_time" content="2025-06-18T20:06:28.046Z">
<meta property="article:author" content="Michael(Jiahao) Luo">
<meta property="article:tag" content="rust">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.blog-blockchain.xyz/2025/03/7a1eb877711a4e78b90307ccefde92f4.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ·±å…¥å­¦ä¹ Rustå¼‚æ­¥ç¼–ç¨‹ï¼šmini-redisé¡¹ç›®è§£æ",
  "url": "https://www.blog-blockchain.xyz/dev/study-mini-redis/",
  "image": "https://cdn.blog-blockchain.xyz/2025/03/7a1eb877711a4e78b90307ccefde92f4.png",
  "datePublished": "2025-03-22T20:33:20.000Z",
  "dateModified": "2025-06-18T20:06:28.046Z",
  "author": [
    {
      "@type": "Person",
      "name": "Michael(Jiahao) Luo",
      "url": "https://www.blog-blockchain.xyz/"
    }
  ]
}</script><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://www.blog-blockchain.xyz/dev/study-mini-redis/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/pwa/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/pwa/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/pwa/16.png"><link rel="mask-icon" href="/pwa/safari-pinned-tab.svg" color="#5bbad5"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?372b8854d18acf62880149b1e08e1901";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=QXcJQjXxTMeUwnWykFW2xw"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'QXcJQjXxTMeUwnWykFW2xw')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'QXcJQjXxTMeUwnWykFW2xw', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'æ·±å…¥å­¦ä¹ Rustå¼‚æ­¥ç¼–ç¨‹ï¼šmini-redisé¡¹ç›®è§£æ',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Jiahao Luo" type="application/atom+xml">
<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');loadCss('https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css');loadCss('https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.min.css');loadCss('https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.min.css');loadCss('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css');</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css"></noscript></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/site-avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">56</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">29</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archive</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Jiahao Luo</span></a><a class="nav-page-title" href="/"><span class="site-name">æ·±å…¥å­¦ä¹ Rustå¼‚æ­¥ç¼–ç¨‹ï¼šmini-redisé¡¹ç›®è§£æ</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archive</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">æ·±å…¥å­¦ä¹ Rustå¼‚æ­¥ç¼–ç¨‹ï¼šmini-redisé¡¹ç›®è§£æ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-22T20:33:20.000Z" title="Created 2025-03-23 04:33:20">2025-03-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-06-18T20:06:28.046Z" title="Updated 2025-06-19 04:06:28">2025-06-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/rust/">rust</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">8.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>30mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><h2 id="å‰è¨€">å‰è¨€</h2>
<p>ä¸ºäº†æ·±å…¥å­¦ä¹ Rustç¼–ç¨‹çš„æœ€ä½³å®è·µï¼Œå¹¶ç†Ÿæ‚‰æˆç†Ÿä¸”ä¸»æµçš„tokioå¼‚æ­¥è¿è¡Œæ—¶ï¼Œæˆ‘å†³å®šé€šè¿‡å­¦ä¹ mini-redisé¡¹ç›®æ¥æå‡è‡ªå·±çš„Rusté«˜æ€§èƒ½ç¼–ç¨‹èƒ½åŠ›ã€‚æœ¬æ–‡è®°å½•äº†æˆ‘å¯¹è¯¥é¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹å’Œç†è§£ã€‚</p>
<p>é¡¹ç›®åœ°å€ï¼š<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/tokio-rs/mini-redis">https://github.com/tokio-rs/mini-redis</a></p>
<h2 id="é¡¹ç›®æ¶æ„æ¦‚è§ˆ">é¡¹ç›®æ¶æ„æ¦‚è§ˆ</h2>
<pre class="mermaid">graph TD
    %% Main components with subgraph structure
    subgraph æ ¸å¿ƒæœåŠ¡å™¨ ["æ ¸å¿ƒæœåŠ¡å™¨ç»„ä»¶"]
        server["server<br>RedisæœåŠ¡å™¨å®ç°"]
        shutdown["shutdown<br>ä¼˜é›…å…³é—­æœºåˆ¶"]
        db["db<br>é”®å€¼å­˜å‚¨å’Œå‘å¸ƒ/è®¢é˜…"]
    end

    subgraph é€šä¿¡å±‚ ["é€šä¿¡å±‚ç»„ä»¶"]
        connection["connection<br>TCPè¿æ¥ç®¡ç†"]
        parse["parse<br>TCPå­—èŠ‚æµè§£æ"]
        frame["frame<br>Redisåè®®å¸§è¡¨ç¤º"]
    end

    subgraph å®¢æˆ·ç«¯äº¤äº’ ["å®¢æˆ·ç«¯äº¤äº’ç»„ä»¶"]
        clients["clients<br>å¼‚æ­¥å’Œé˜»å¡å®¢æˆ·ç«¯"]
        cmd["cmd<br>Rediså‘½ä»¤å®ç°"]
    end

    %% Relationship arrows with labels
    server --&gt;|"åˆå§‹åŒ–å’Œç®¡ç†"| connection
    server --&gt;|"åˆ›å»ºå’Œç»´æŠ¤"| db
    server --&gt;|"è§¦å‘"| shutdown

    connection --&gt;|"å‘é€/æ¥æ”¶"| frame
    parse --&gt;|"ç”Ÿæˆ"| frame

    clients --&gt;|"å»ºç«‹"| connection
    clients --&gt;|"å‘å‡º"| cmd

    cmd --&gt;|"ç¼–ç ä¸º"| frame
    db --&gt;|"å“åº”è½¬æ¢ä¸º"| frame

    %% Add clear data flow
    frame --&gt;|"æ‰§è¡Œå¹¶æ›´æ–°"| db
    connection --&gt;|"ä¼ é€’åˆ°"| parse

    %% Visual styling
    classDef core fill:#f9d5e5,stroke:#333,stroke-width:1px
    classDef comm fill:#eeeeee,stroke:#333,stroke-width:1px
    classDef client fill:#d0f0c0,stroke:#333,stroke-width:1px

    class server,shutdown,db core
    class connection,parse,frame comm
    class clients,cmd client</pre>
<ol>
<li>
<p><strong>æ ¸å¿ƒæœåŠ¡å™¨ç»„ä»¶</strong></p>
<ul>
<li>ğŸ”¹ <strong>server</strong>ï¼šRedisæœåŠ¡å™¨æ ¸å¿ƒï¼Œå¯åŠ¨æœåŠ¡è¿›ç¨‹ï¼Œç®¡ç†è¿æ¥å’Œè¯·æ±‚å¤„ç†æµç¨‹</li>
<li>ğŸ”¹ <strong>db</strong>ï¼šå®ç°é”®å€¼å­˜å‚¨å¼•æ“ï¼Œç®¡ç†æ•°æ®ç»“æ„å’Œå‘å¸ƒ/è®¢é˜…åŠŸèƒ½</li>
<li>ğŸ”¹ <strong>shutdown</strong>ï¼šå¤„ç†æœåŠ¡å™¨æ­£å¸¸å…³é—­æµç¨‹ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œè¿æ¥ä¼˜é›…ç»ˆæ­¢</li>
</ul>
</li>
<li>
<p><strong>é€šä¿¡å±‚ç»„ä»¶</strong></p>
<ul>
<li>ğŸ”¹ <strong>connection</strong>ï¼šç®¡ç†TCPè¿æ¥ç”Ÿå‘½å‘¨æœŸï¼Œå¤„ç†ç½‘ç»œI/Oå’Œäº‹ä»¶å¾ªç¯</li>
<li>ğŸ”¹ <strong>parse</strong>ï¼šå°†TCPå­—èŠ‚æµè§£æä¸ºåè®®æ ¼å¼ï¼Œå¤„ç†åˆ†åŒ…å’Œç²˜åŒ…é—®é¢˜</li>
<li>ğŸ”¹ <strong>frame</strong>ï¼šRedisåè®®å¸§çš„ç¼–ç è§£ç å™¨ï¼Œè½¬æ¢å‘½ä»¤ä¸äºŒè¿›åˆ¶è¡¨ç¤º</li>
</ul>
</li>
<li>
<p><strong>å®¢æˆ·ç«¯äº¤äº’ç»„ä»¶</strong></p>
<ul>
<li>ğŸ”¹ <strong>clients</strong>ï¼šæä¾›å¼‚æ­¥å’Œé˜»å¡å¼å®¢æˆ·ç«¯APIï¼Œå¤„ç†è¿æ¥æ± å’Œè¯·æ±‚é˜Ÿåˆ—</li>
<li>ğŸ”¹ <strong>cmd</strong>ï¼šå®ç°Rediså‘½ä»¤é›†ï¼Œå¤„ç†å‘½ä»¤éªŒè¯ã€æ‰§è¡Œå’Œå“åº”ç”Ÿæˆ</li>
</ul>
</li>
</ol>
<p>æœåŠ¡å™¨å¯åŠ¨æ—¶åˆå§‹åŒ–å„ç»„ä»¶ï¼Œå»ºç«‹è¿æ¥ç›‘å¬å’Œå¤„ç†ç®¡é“ã€‚å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ç»ç”±connectionç»„ä»¶å¤„ç†ï¼Œå»ºç«‹ä¼šè¯ã€‚å®¢æˆ·ç«¯å‘½ä»¤ç»è¿‡åè®®ç¼–ç ï¼Œé€šè¿‡è¿æ¥å‘é€åˆ°æœåŠ¡å™¨ã€‚æœåŠ¡å™¨è§£æå‘½ä»¤ååœ¨dbç»„ä»¶ä¸­æ‰§è¡Œï¼Œå¹¶å°†ç»“æœè¿”å›ã€‚æ‰€æœ‰ç»„ä»¶å…±åŒåä½œï¼Œç¡®ä¿æ•°æ®æµè½¬é«˜æ•ˆå’Œé”™è¯¯å¤„ç†å®Œå–„ã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸‹ mini-redis çš„åŸºæœ¬åŠŸèƒ½ï¼Œå…·ä½“åœ¨ README é‡Œï¼Œç„¶åå†é€æ­¥å®ç°ã€‚æœ€ç®€å•çš„è¯»ã€å†™ã€Pingã€ä»¥åŠè®¢é˜…æ›´æ–°çš„åŠŸèƒ½ã€‚</p>
<h2 id="å®ç°">å®ç°</h2>
<h3 id="db-æ¨¡å—">db æ¨¡å—</h3>
<h4 id="æ•°æ®ç»“æ„å’Œåå°ä»»åŠ¡">æ•°æ®ç»“æ„å’Œåå°ä»»åŠ¡</h4>
<pre class="mermaid">classDiagram
    class Db {
        +new() Db
        +get(key: String) Option~Bytes~
        +set(key: String, value: Bytes, expiration: Option~Duration~) void
        +subscribe(channel: String) Receiver~Bytes~
        +publish(channel: String, message: Bytes) usize
    }

    class Shared {
        -state: Mutex~State~
        -background_task: Notify
    }

    class State {
        -entries: HashMap~String, Entry~
        -pub_sub: HashMap~String, Sender~Bytes~~
        -expirations: BTreeSet~(Instant, String)~
        -shutdown: bool
    }

    class Entry {
        -data: Bytes
        -expires_at: Option~Instant~
    }

    class BackgroundTask {
        -run() async
        -expire_keys() usize
        -sleep_until_next_expiration() Future
    }

    Db *-- Shared : contains
    Shared *-- State : protects
    State *-- Entry : stores
    State o-- BackgroundTask : triggers

    note for BackgroundTask "åå°ä»»åŠ¡è´Ÿè´£æ¸…ç†è¿‡æœŸé”®å€¼å¯¹"
    note for Shared "ä½¿ç”¨ArcåŒ…è£…ï¼Œå…è®¸å¤šçº¿ç¨‹å…±äº«è®¿é—®"
    note for Entry "å­˜å‚¨å€¼å’Œè¿‡æœŸæ—¶é—´"</pre>
<p>Redis æ˜¯ä¸€ä¸ªåŸºäºé”®å€¼å¯¹çš„æ•°æ®ç»“æ„æœåŠ¡å™¨ï¼Œå®ƒæ”¯æŒå¤šç§ç±»å‹çš„å€¼ï¼Œè€Œä¸”æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªé”®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œåˆ°äº†è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œå¦‚æœé”®è¿˜æ²¡æœ‰è¢«æ›´æ–°ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨ä»æ•°æ®åº“ä¸­åˆ é™¤ã€‚æˆ‘ä»¬çš„å€¼å…¨éƒ¨å½“ä½œæ˜¯ Bytes ç±»å‹ï¼Œè¿‡æœŸæ—¶é—´è®¾ç½®åœ¨ value é‡Œã€‚æ³¨æ„æœ‰çš„å€¼æ˜¯æ°¸ä¸è¿‡æœŸçš„ï¼Œæ‰€ä»¥ expires_at æ˜¯ Option ç±»å‹ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Entry in the key-value store</span></span><br><span class="line">#<span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Entry</span> {</span><br><span class="line">    <span class="comment">/// Stored data</span></span><br><span class="line">    data: Bytes,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Instant at which the entry expires and should be removed from the</span></span><br><span class="line">    <span class="comment">/// database.</span></span><br><span class="line">    expires_at: <span class="type">Option</span>&lt;Instant&gt;,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åéœ€è¦ç»´æŠ¤æ•´ä¸ª db çŠ¶æ€çš„å˜é‡ï¼Œå®ƒéœ€è¦ä¸æ–­çš„æ‰«æè¿‡æœŸæ—¶é—´ï¼Œåˆ é™¤è¿‡æœŸçš„é”®å€¼å¯¹ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨æœ‰åºçš„ æ—¶åˆ»-&gt;é”® çš„æ˜ å°„ï¼Œè¿™é‡Œä½¿ç”¨ BTreeSet æ¥å®ç°ã€‚</p>
<p>Redis çš„ pub/sub å¯ä»¥è®¾ç½®ä¸åŒçš„é¢‘é“ï¼Œç„¶åç›¸åŒçš„é¢‘é“å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€…ï¼Œå°±æ˜¯ä¸€ä¸ªå¹¿æ’­æœºåˆ¶ã€‚æ‰€ä»¥å°±æœ‰ é¢‘é“ -&gt; å¹¿æ’­ çš„æ˜ å°„ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">State</span> {</span><br><span class="line">    <span class="comment">/// é”®å€¼æ•°æ®ã€‚ä½¿ç”¨æ ‡å‡†çš„HashMapå³å¯æ»¡è¶³éœ€æ±‚</span></span><br><span class="line">    entries: HashMap&lt;<span class="type">String</span>, Entry&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// å‘å¸ƒ/è®¢é˜…é”®ç©ºé—´ã€‚Redisä¸ºé”®å€¼å’Œå‘å¸ƒ/è®¢é˜…ä½¿ç”¨å•ç‹¬çš„é”®ç©ºé—´</span></span><br><span class="line">    pub_sub: HashMap&lt;<span class="type">String</span>, broadcast::Sender&lt;Bytes&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// è·Ÿè¸ªé”®çš„TTL</span></span><br><span class="line">    <span class="comment">/// ä½¿ç”¨BTreeSetæŒ‰è¿‡æœŸæ—¶é—´æ’åº</span></span><br><span class="line">    <span class="comment">/// è¿™å…è®¸åå°ä»»åŠ¡éå†æ­¤æ˜ å°„ä»¥æ‰¾åˆ°ä¸‹ä¸€ä¸ªè¿‡æœŸçš„å€¼</span></span><br><span class="line">    expirations: BTreeSet&lt;(Instant, <span class="type">String</span>)&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// å½“Dbå®ä¾‹å…³é—­æ—¶ä¸ºtrue</span></span><br><span class="line">    <span class="comment">/// è®¾ç½®ä¸ºtrueæ—¶é€šçŸ¥åå°ä»»åŠ¡é€€å‡º</span></span><br><span class="line">    shutdown: <span class="type">bool</span>,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è§¦å‘è¿‡æœŸçš„æ£€æŸ¥æ˜¯åœ¨åå°çº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼Œä¸€èˆ¬æ˜¯2ä¸ªè§¦å‘åœºæ™¯ï¼Œç¬¬ä¸€ä¸ªæ˜¯åå°å®šæ—¶è§¦å‘ï¼Œç¬¬äºŒä¸ªæ˜¯æœ‰æ–°çš„é”®å€¼å¯¹æ’å…¥ï¼Œå¦‚æœæ—¶é—´æ¯”ä¹‹å‰çš„éƒ½æ—©ï¼Œè¿™æ—¶å€™éœ€è¦æ›´æ–°è¿‡æœŸæ—¶é—´ã€‚æ‰€ä»¥éœ€è¦ä¸€ä¸ª Notify æ¥é€šçŸ¥åå°çº¿ç¨‹ã€‚å®šæ—¶å™¨è§¦å‘ä¸€èˆ¬æ³¨æ„2ç‚¹ï¼š</p>
<ol>
<li>æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹åº”è¯¥ä¼‘çœ ï¼Œä¸è¦ç©ºè½¬ã€‚</li>
<li>å¦‚æœæœ‰ä»»åŠ¡ï¼Œç­‰å¾…çš„æ—¶é—´åº”è¯¥æ˜¯ä¸‹ä¸€ä¸ªçš„è¿‡æœŸæ—¶é—´ï¼Œè€Œä¸æ˜¯å›ºå®šçš„æ—¶é—´é—´éš”ã€‚</li>
</ol>
<h4 id="è¯»å’Œå†™">è¯»å’Œå†™</h4>
<p>è¯»å’Œå†™éƒ½è¦åŠ é”ï¼Œå› ä¸ºè¯»å†™éƒ½ä¼šä¿®æ”¹ entriesï¼Œæ‰€ä»¥éœ€è¦ Mutex æ¥ä¿æŠ¤ã€‚è¯»çš„æ—¶å€™æ•°æ®è¦ clone ä¸€ä»½ï¼Œå› ä¸ºå“ˆå¸Œè¡¨é‡Œè¿˜æ˜¯å­˜å‚¨ç€çš„ã€‚</p>
<p>å†™çš„æ—¶å€™ï¼Œå¦‚æœæŒ‡å®šäº†è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆéœ€è¦æ›´æ–° expirationsï¼Œå¦‚æœä¹‹å‰æœ‰è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆéœ€è¦åˆ é™¤ä¹‹å‰çš„ï¼Œç„¶åæ›´æ–°ã€‚</p>
<h4 id="Pub-Sub">Pub/Sub</h4>
<p>è®¢é˜…å¾ˆç®€å•ï¼Œåˆ›å»ºä¸€ä¸ª broadcast::channelï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ª Receiverï¼Œç„¶åæŠŠ Sender å­˜å‚¨åˆ° pub_sub é‡Œã€‚å‘å¸ƒçš„æ—¶å€™ï¼Œä½¿ç”¨ç›¸åŒçš„é¢‘é“ï¼Œå‘é€æ¶ˆæ¯å³å¯ã€‚</p>
<h3 id="Redisåè®®å¸§">Redisåè®®å¸§</h3>
<p>Redis åè®®æ˜¯ä¸€ä¸ªç®€å•çš„æ–‡æœ¬åè®®ï¼Œå®ƒæ˜¯åŸºäº TCP çš„ï¼Œæ‰€ä»¥æ˜¯å­—èŠ‚æµã€‚æˆ‘ä»¬éœ€è¦æŠŠå­—èŠ‚æµè§£ææˆ Redis å‘½ä»¤ï¼Œç„¶åæ‰§è¡Œï¼Œç„¶åæŠŠç»“æœåºåˆ—åŒ–æˆå­—èŠ‚æµè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>RESP æ˜¯ Redis å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´é€šä¿¡çš„åè®®ï¼Œè®¾è®¡ç®€å•ä¸”æ˜“äºå®ç°ã€‚RESP æ”¯æŒ 5 ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼š</p>
<ol>
<li>ç®€å•å­—ç¬¦ä¸² (Simple Strings)
<ul>
<li>æ ¼å¼ï¼š<code>+&lt;string&gt;\r\n</code></li>
<li>ä¾‹å­ï¼š<code>+OK\r\n</code></li>
<li>è¯´æ˜ï¼šä¸èƒ½åŒ…å«æ¢è¡Œç¬¦ã€‚</li>
</ul>
</li>
<li>é”™è¯¯ (Errors)
<ul>
<li>æ ¼å¼ï¼š<code>-&lt;error message&gt;\r\n</code></li>
<li>ä¾‹å­ï¼š<code>-ERR unknown command 'foobar'\r\n</code></li>
<li>è¯´æ˜ï¼šå®¢æˆ·ç«¯åº”å°†å…¶è§†ä¸ºå¼‚å¸¸ã€‚</li>
</ul>
</li>
<li>æ•´æ•° (Integers)
<ul>
<li>æ ¼å¼ï¼š<code>:&lt;number&gt;\r\n</code></li>
<li>ä¾‹å­ï¼š<code>:1000\r\n</code></li>
<li>è¯´æ˜ï¼š64 ä½æœ‰ç¬¦å·æ•´æ•°ã€‚</li>
</ul>
</li>
<li>æ‰¹é‡å­—ç¬¦ä¸² (Bulk Strings)
<ul>
<li>æ ¼å¼ï¼š<code>$&lt;length&gt;\r\n&lt;data&gt;\r\n</code></li>
<li>ä¾‹å­ï¼š<code>$5\r\nhello\r\n</code></li>
<li>è¯´æ˜ï¼š
<ul>
<li>å¯ä»¥è¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ã€‚</li>
<li>ç©ºå­—ç¬¦ä¸²ï¼š<code>$0\r\n\r\n</code></li>
<li>ç©ºå€¼ï¼š<code>$-1\r\n</code></li>
</ul>
</li>
</ul>
</li>
<li>æ•°ç»„ (Arrays)
<ul>
<li>æ ¼å¼ï¼š<code>*&lt;number of elements&gt;\r\n&lt;element1&gt;...&lt;elementN&gt;</code></li>
<li>ä¾‹å­ï¼š<code>*2\r\n$5\r\nhello\r\n$5\r\nworld\r\n</code></li>
<li>è¯´æ˜ï¼š
<ul>
<li>å¯ä»¥åŒ…å«ä¸åŒç±»å‹çš„å…ƒç´ ã€‚</li>
<li>ç©ºæ•°ç»„ï¼š<code>*0\r\n</code></li>
<li>ç©ºå€¼æ•°ç»„ï¼š<code>*-1\r\n</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>å®¢æˆ·ç«¯è¯·æ±‚é€šå¸¸ä½¿ç”¨æ•°ç»„æ ¼å¼å‘é€å‘½ä»¤ï¼Œä¾‹å¦‚ SET key value è¢«ç¼–ç ä¸ºï¼š<br>
<code>*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$5\r\nvalue\r\n</code></p>
<p>æœåŠ¡å™¨å“åº”æ ¹æ®å‘½ä»¤è¿”å›é€‚å½“çš„ RESP æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ GET key å¯èƒ½è¿”å› <code>$5\r\nhello\r\n</code> æˆ–è€… <code>$-1\r\n</code>ã€‚</p>
<p>æ ¹æ®ä¸Šé¢çš„ç‰¹å¾ï¼Œå¸§è§£æçš„æ—¶å€™ï¼Œé¦–å…ˆè¯»å–ç¬¬ä¸€ä¸ªå­—èŠ‚ç¡®å®šç±»å‹ï¼Œç„¶ååŸºäºç±»å‹è§£æå‰©ä½™æ•°æ®ã€‚è€Œä¸”è¿™æ˜¯å…¸å‹çš„å­—ç¬¦ä¸²çŠ¶æ€æœºï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨çŠ¶æ€æœºæ¨¡å¼æ¥å®ç°ï¼Œé€æ­¥æ„å»ºå®Œæ•´çš„ RESP å¯¹è±¡ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A frame in the Redis protocol.</span></span><br><span class="line">#<span class="meta">#[derive(Clone, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Frame</span> {</span><br><span class="line">    <span class="title function_ invoke__">Simple</span>(<span class="type">String</span>),</span><br><span class="line">    <span class="title function_ invoke__">Error</span>(<span class="type">String</span>),</span><br><span class="line">    <span class="title function_ invoke__">Integer</span>(<span class="type">u64</span>),</span><br><span class="line">    <span class="title function_ invoke__">Bulk</span>(Bytes),</span><br><span class="line">    Null,</span><br><span class="line">    <span class="title function_ invoke__">Array</span>(<span class="type">Vec</span>&lt;Frame&gt;),</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>+&lt;string&gt;\r\n</code> å’Œ <code>-&lt;error message&gt;\r\n</code> éƒ½æ¯”è¾ƒç®€å•ï¼Œä¸€ç›´æ‰¾åˆ° <code>\r\n</code> ä¸ºæ­¢ï¼Œç„¶åè¿”å› Simple ç±»å‹ã€‚<br>
å¦‚æœæ˜¯æ•´æ•° <code>:&lt;number&gt;\r\n</code>ï¼Œåˆ™éœ€è¦é¢å¤–çš„åˆ¤æ–­æ˜¯å¦èƒ½ç¼–ç æˆ u64ã€‚<br>
å¦‚æœæ˜¯äºŒè¿›åˆ¶æ•°æ® <code>$&lt;length&gt;\r\n&lt;data&gt;\r\n</code>ï¼Œè¦æ³¨æ„ç©ºå­—ç¬¦ä¸²å’Œç©ºå€¼çš„æƒ…å†µã€‚<br>
å¦‚æœæ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯æ•´æ•°æ ¼å¼ï¼Œç„¶åé€’å½’è§£ææ¯ä¸ªå…ƒç´ ã€‚</p>
<h3 id="è¿æ¥æ¨¡å—">è¿æ¥æ¨¡å—</h3>
<p>è¿æ¥æ¨¡å—å®ç°ç½‘ç»œè¯»å†™Rediså¸§çš„åŠŸèƒ½ï¼ŒåŸºäºtokioçš„å¼‚æ­¥ç½‘ç»œåº“ã€‚ä¸€ä¸ªåŸºæœ¬è¿æ¥éœ€å®ç°ï¼š</p>
<ul>
<li>åˆå§‹åŒ–è¿æ¥ï¼šå»ºç«‹åº•å±‚ç½‘ç»œè¿æ¥</li>
<li>è¯»å–æ•°æ®ï¼šä»ç½‘ç»œè¿æ¥è¯»å–æ•°æ®</li>
<li>å†™å…¥æ•°æ®ï¼šå‘ç½‘ç»œè¿æ¥å†™å…¥æ•°æ®</li>
<li>å¤„ç†æ•°æ®ï¼šè§£æå’Œå¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®</li>
<li>ç»´æŠ¤è¿æ¥çŠ¶æ€ï¼šç›‘æ§è¿æ¥çŠ¶æ€ï¼Œå¤„ç†å„ç§äº‹ä»¶</li>
</ul>
<p>æˆ‘ä»¬ä½¿ç”¨BufWriter<tcpstream>è€Œéç›´æ¥ä½¿ç”¨TcpStreamï¼Œå®ƒç»´æŠ¤å†…éƒ¨ç¼“å†²åŒºï¼Œä¼˜åŒ–ç³»ç»Ÿäº¤äº’ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ã€‚åŒæ—¶ä½¿ç”¨BytesMutç»´æŠ¤è¯»å–ä½†æœªå¤„ç†çš„æ•°æ®ï¼Œå®ç°é›¶æ‹·è´æå‡æ€§èƒ½ã€‚</tcpstream></p>
<p>å› ä¸º TCP åè®®åªä¿è¯å­—èŠ‚æµçš„é¡ºåºï¼Œä¸ä¿è¯æ•°æ®åŒ…çš„è¾¹ç•Œã€‚å·²ç»è¯»å–ä½†æ˜¯è¿˜æ²¡æœ‰å¤„ç†çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ç»´æŠ¤ä¸€ä¸ªç¼“å†²åŒºï¼Œè€Œä¸æ˜¯é¢‘ç¹è®¿é—®ç³»ç»Ÿçš„TCPç¼“å†²åŒºã€‚å¸¸è§çš„åšæ³•æ˜¯ä½¿ç”¨ Vec<u8> æ¥ç»´æŠ¤ï¼Œä½†æ˜¯ BytesMut å®ç°äº†é›¶æ‹·è´ï¼Œåªæœ‰åœ¨å®é™…éœ€è¦ä¿®æ”¹çš„æ—¶å€™æ‰ä¼šæ‹·è´ï¼Œåœ¨è¯»å–ã€åˆå¹¶ç­‰æ“ä½œçš„æ—¶å€™ï¼Œåªæ˜¯ç§»åŠ¨æŒ‡é’ˆï¼Œæ‰€ä»¥æ€§èƒ½æ›´å¥½ã€‚</u8></p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Connection</span> {</span><br><span class="line">    <span class="comment">// The `TcpStream`. It is decorated with a `BufWriter`, which provides write</span></span><br><span class="line">    <span class="comment">// level buffering. The `BufWriter` implementation provided by Tokio is</span></span><br><span class="line">    <span class="comment">// sufficient for our needs.</span></span><br><span class="line">    stream: BufWriter&lt;TcpStream&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The buffer for reading frames.</span></span><br><span class="line">    buffer: BytesMut,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å½“è¯»åˆ°ä¸€ä¸ªæ•°æ®æµçš„æ—¶å€™ï¼Œè¦å°è¯•è§£ææˆä¸€ä¸ªå®Œæ•´çš„ RESP å¸§ï¼Œå¦‚æœè§£ææˆåŠŸï¼Œå°±è¿”å›ä¸€ä¸ª Frameï¼Œ<br>
ç„¶åæŠŠå‰©ä½™çš„æ•°æ®æ”¾å› buffer é‡Œã€‚å…·ä½“è§£æçš„æ—¶å€™ï¼Œä½¿ç”¨ Cursor æ¥è¯»å– bufferï¼Œæ–¹ä¾¿è®¾ç½® positionï¼Œå¤„ç†å­—èŠ‚æµã€‚å¦‚æœæ„æˆä¸€ä¸ªå®Œæ•´çš„ RESP å¸§ï¼Œå°±è¦è®°å¾— advanceï¼ŒæŠŠå·²ç»å¤„ç†çš„å­—èŠ‚å»æ‰ï¼Œè¿™æ®µå†…å­˜ç©ºå‡ºæ¥ã€‚æ­¤æ—¶ buffer åˆå¼€å§‹ä» 0 å¼€å§‹ã€‚</p>
<p>å¦‚æœè§£æå¤±è´¥ï¼Œå°±ç»§ç»­è¯»å–ï¼Œç›´åˆ°è§£ææˆåŠŸã€‚è€ƒè™‘ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœè¯»å–å­—èŠ‚ä¸º0ï¼Œè¯´æ˜å¯¹ç«¯å…³é—­äº†è¿æ¥ï¼Œå¦‚æœæ­¤æ—¶bufferè¿˜å­˜åœ¨æ•°æ®ï¼Œå°±è¯´æ˜æ˜¯å¼‚å¸¸æ–­å¼€äº†ã€‚</p>
<p>å†™å…¥çš„æ—¶å€™ï¼Œéœ€è¦æŠŠFrameåºåˆ—åŒ–æˆå­—èŠ‚æµï¼Œç„¶åå†™å…¥åˆ° stream é‡Œï¼Œè¦æ³¨æ„å†™å…¥çš„å­—èŠ‚æµå¯èƒ½æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥è¦åˆ†æ­¥å†™å…¥ï¼Œç›´åˆ°å…¨éƒ¨å†™å…¥å®Œæˆã€‚æœ€åè®°å¾— flushï¼ŒæŠŠç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ°ç³»ç»Ÿçš„ TCP ç¼“å†²åŒºã€‚</p>
<h3 id="æœåŠ¡å™¨æ¨¡å—">æœåŠ¡å™¨æ¨¡å—</h3>
<p>è¿™ä¸ªæ¨¡å—å°±å¼€å§‹æ±‡æ€»å‰é¢çš„æ¨¡å—ï¼Œå®ç°ä¸€ä¸ªå®Œæ•´çš„ Redis æœåŠ¡å™¨ã€‚<br>
ä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„ä½“ï¼Œç„¶åå®ç°ä¸€äº›éœ€è¦å¯¹å¤–éƒ¨æš´éœ²çš„æ–¹æ³•ï¼Œæ¯”å¦‚å¯åŠ¨ã€å…³é—­ã€å¤„ç†è¿æ¥ç­‰ã€‚å†…éƒ¨çš„å„ä¸ªå­ç»“æ„ä½“ï¼Œå°±æ˜¯å„ä¸ªåŠŸèƒ½æ¨¡å—ï¼Œæ¥ç€åœ¨è¿™ä¸ªå¤§ç»“æ„ä½“é‡Œé€æ¸å¯åŠ¨ã€‚å¤§ç»“æ„ä½“é‡Œï¼Œé™¤äº†å„ä¸ªæ¨¡å—çš„å®ä¾‹ï¼Œè¿˜æœ‰ä¸€äº›å…±äº«çš„æ•°æ®ï¼Œæ¯”å¦‚é…ç½®ã€æ—¥å¿—ã€è®¡æ•°å™¨ï¼Œå°¤å…¶æ˜¯ä¸€äº›æ§åˆ¶ä¿¡å·ï¼Œç”¨äºåè°ƒå„ä¸ªæ¨¡å—çš„å·¥ä½œï¼Œæ¯”å¦‚åœæ­¢æœåŠ¡çš„é¡ºåºã€‚è¿™ä¸ªè®¾è®¡æ¨¡å¼å«åšï¼šä¸­ä»‹è€…æ¨¡å¼ã€‚</p>
<p>ç„¶åä¸€ä¸ªæ¨¡å—æœ‰æ›´æ–°ï¼Œæ¯”å¦‚åè®®æ›´æ–°ï¼Œå‡ºç°äº†å¹¶å­˜çš„å®ä¾‹ï¼Œé‚£ä¹ˆè¿™ä¸ªå±€éƒ¨å¯ä»¥ä½¿ç”¨å¤–è§‚æ¨¡å¼ï¼ŒæŠŠè¿™äº›å®ä¾‹éšè—èµ·æ¥ï¼Œå¯¹å¤–æš´éœ²ä¸€ä¸ªæ¥å£ï¼Œè¿™ä¸ªæ¥å£å¯ä»¥æ ¹æ®é…ç½®ï¼Œé€‰æ‹©ä¸åŒçš„å®ä¾‹ã€‚</p>
<p>æ§åˆ¶ä¿¡å·éœ€è¦ 2 ä¸ªï¼Œä¸€ä¸ªç”¨äºé€šçŸ¥è¿æ¥é€€å‡ºï¼Œå› ä¸º redis æœåŠ¡å™¨å¯èƒ½æœ‰å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥éƒ½æœ‰è‡ªå·±çš„ TCP è¿æ¥è¿›æ¥ï¼Œ<br>
å½“æœåŠ¡å™¨é€€å‡ºçš„æ—¶å€™ï¼Œéœ€è¦é€šçŸ¥æ‰€æœ‰çš„è¿æ¥é€€å‡ºã€‚<br>
å¦ä¸€ä¸ªæ˜¯é€šçŸ¥åå°çº¿ç¨‹é€€å‡ºï¼Œæ¯”å¦‚æ•°æ®åº“çš„éƒ¨åˆ†ï¼Œå®ƒåœ¨ä¸æ–­çš„æ‰«æè¿‡æœŸæ—¶é—´ï¼Œåˆ é™¤è¿‡æœŸçš„é”®å€¼å¯¹ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œéœ€è¦é€šçŸ¥å®ƒé€€å‡ºã€‚</p>
<p>å¦å¤–ä¸€ä¸ªæ§åˆ¶ä¿¡å·æ˜¯å¹¶å‘æ§åˆ¶ï¼Œé™åˆ¶æœåŠ¡å™¨æ¥æ”¶çš„ TCP è¿æ¥æ•°ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Listener</span> {</span><br><span class="line">    db_holder: DbDropGuard,</span><br><span class="line"></span><br><span class="line">    listener: TcpListener,</span><br><span class="line"></span><br><span class="line">    limit_connections: Arc&lt;Semaphore&gt;,</span><br><span class="line">    notify_shutdown: broadcast::Sender&lt;()&gt;,</span><br><span class="line">    shutdown_complete_tx: mpsc::Sender&lt;()&gt;,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸€èˆ¬å¯åŠ¨æœåŠ¡å™¨æ—¶ï¼Œè¦è€ƒè™‘æ§åˆ¶ä¿¡å·ï¼Œè¿˜æœ‰ä¸€äº›ç¨‹åºçš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚æ—¥å¿—ï¼Œ<br>
ä¸€äº›rustè¿è¡Œæ—¶çš„å‚æ•°ï¼Œæ¯”å¦‚çº¿ç¨‹æ•°ï¼Œè¿™äº›éƒ½æ˜¯å…¨å±€çš„ï¼Œéœ€è¦åœ¨å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–ã€‚</p>
<p>æ‰€ä»¥æœ€å¤–å±‚çš„ç»“æ„ä½“ï¼Œä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼Œshutdown æ”¶åˆ°ä¹‹åï¼Œä¼šé€€å‡ºè¿™ä¸ªselectï¼š</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tokio::<span class="built_in">select!</span> {</span><br><span class="line">     res = server.<span class="title function_ invoke__">run</span>() =&gt; {</span><br><span class="line">         <span class="comment">// If an error is received here, accepting connections from the TCP</span></span><br><span class="line">         <span class="comment">// listener failed multiple times and the server is giving up and</span></span><br><span class="line">         <span class="comment">// shutting down.</span></span><br><span class="line">         <span class="comment">//</span></span><br><span class="line">         <span class="comment">// Errors encountered when handling individual connections do not</span></span><br><span class="line">         <span class="comment">// bubble up to this point.</span></span><br><span class="line">         <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(err) = res {</span><br><span class="line">             error!(cause = %err, <span class="string">"failed to accept"</span>);</span><br><span class="line">         }</span><br><span class="line">     }</span><br><span class="line">     _ = shutdown =&gt; {</span><br><span class="line">         <span class="comment">// The shutdown signal has been received.</span></span><br><span class="line">         info!(<span class="string">"shutting down"</span>);</span><br><span class="line">     }</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure>
<p>æ•´ä¸ªæœåŠ¡å™¨æ˜¯ä¸ªå¤§å¾ªç¯ï¼Œé¦–å…ˆéœ€è¦ä¿¡å·é‡æœ‰ç©ºé—²ï¼Œæ‰å…è®¸æ–°çš„è¿æ¥è¿›æ¥ï¼Œ<br>
ç„¶åç›‘å¬æ–°çš„è¿æ¥ï¼ŒæŠŠè¿æ¥å’Œåå°æœåŠ¡æ¨¡å—æ‰“åŒ…è¿› Handlerï¼Œè¿™æ ·å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥çš„ä»»åŠ¡ã€‚<br>
è¿™æ˜¯ä¸ªéå¸¸å¸¸ç”¨çš„ç¨‹åºè®¾è®¡æ€è·¯ï¼ŒæŠŠä¸€ä¸ªä»»åŠ¡çš„å¯åŠ¨å’Œå…³é—­ï¼Œéƒ½å°è£…åœ¨ä¸€ä¸ªç»“æ„ä½“é‡Œï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿çš„æ§åˆ¶ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€‚<br>
è€Œä¸”ä¹Ÿæ–¹ä¾¿åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Œå¯åŠ¨è¿™ä¸ªä»»åŠ¡ã€‚</p>
<p>è¿™é‡Œé€šè¿‡å°è£… TcpListener è‡ªå®šä¹‰äº† acceptï¼Œå®ç°äº†æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œå¦‚æœ accept å¤±è´¥ï¼Œå°±ç­‰å¾…ä¸€æ®µæ—¶é—´å†å°è¯•ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œæé«˜æ€§èƒ½ã€‚<br>
ä¸€èˆ¬ accept å¤±è´¥éƒ½æ˜¯ç³»ç»Ÿå†…éƒ¨é”™è¯¯ã€‚</p>
<p>è¿™é‡Œå°±æ¶‰åŠåˆ°å…‹éš†çš„è§„åˆ™äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›æ¯ä¸ªè¿æ¥éƒ½å…±äº«æ•°æ®åº“å®ä¾‹ã€‚rustçš„clone åˆ†æˆäº†æ·±æ‹·è´å’Œæµ…æ‹·è´ï¼Œshallow clone ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œdeep clone ä¼šå¤åˆ¶æ•´ä¸ªå¯¹è±¡ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„æ˜¯æµ…æ‹·è´ï¼Œæ‰€ä»¥ä½¿ç”¨ Arc æ¥åŒ…è£…æ•°æ®åº“å®ä¾‹ã€‚</p>
<blockquote>
<p>å¯¹äºç»“æ„ä½“è¿™ç§å¤åˆç±»å‹ï¼Œå…¶å…‹éš†è¡Œä¸ºéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p>
<ol>
<li><strong>é»˜è®¤æ´¾ç”Ÿçš„Cloneå®ç°</strong> (<code>#[derive(Clone)]</code>)ï¼šä¼šé€’å½’åœ°å…‹éš†ç»“æ„ä½“ä¸­çš„æ¯ä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µçš„å…‹éš†è¡Œä¸ºå–å†³äºè¯¥å­—æ®µç±»å‹è‡ªå·±çš„Cloneå®ç°ï¼Œæœ€ç»ˆç»“æœæ˜¯ç»“æ„ä½“ä¸­æ‰€æœ‰å­—æ®µéƒ½è¢«å…‹éš†ã€‚</li>
<li><strong>æ‰‹åŠ¨å®ç°çš„Clone</strong>ï¼šå¯ä»¥è‡ªå®šä¹‰ä»»ä½•å…‹éš†è¡Œä¸ºï¼Œå¯ä»¥é€‰æ‹©æ€§åœ°å…‹éš†æŸäº›å­—æ®µæˆ–ä½¿ç”¨ä¸åŒçš„å…‹éš†ç­–ç•¥</li>
</ol>
<p>ğŸ“Œ ä¾‹1ï¼šæ‰€æœ‰å­—æ®µè¿›è¡Œæ·±å…‹éš†çš„ç»“æ„ä½“</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Person</span> {</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    age: <span class="type">u32</span>,</span><br><span class="line">    hobbies: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt;,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() {</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">person1</span> = Person {</span><br><span class="line">        name: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">"Alice"</span>),</span><br><span class="line">        age: <span class="number">30</span>,</span><br><span class="line">        hobbies: <span class="built_in">vec!</span>[<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">"Reading"</span>), <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">"Hiking"</span>)],</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">person2</span> = person1.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œ<code>Person</code>çš„å…‹éš†ä¼šåˆ›å»ºä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œå› ä¸ºæ‰€æœ‰å­—æ®µ(<code>String</code>ã€<code>u32</code>ã€<code>Vec&lt;String&gt;</code>)éƒ½å®ç°äº†æ·±å…‹éš†ã€‚</p>
<p>ğŸ“Œ ä¾‹2ï¼šåŒ…å«å¼•ç”¨è®¡æ•°çš„ç»“æ„ä½“ï¼ˆæ··åˆå…‹éš†è¡Œä¸ºï¼‰</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Arc;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Document</span> {</span><br><span class="line">    title: <span class="type">String</span>,                <span class="comment">// æ·±å…‹éš†</span></span><br><span class="line">    content: <span class="type">String</span>,              <span class="comment">// æ·±å…‹éš†</span></span><br><span class="line">    shared_metadata: Arc&lt;Metadata&gt;, <span class="comment">// æµ…å…‹éš†ï¼ˆåªå¢åŠ å¼•ç”¨è®¡æ•°ï¼‰</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Metadata</span> {</span><br><span class="line">    author: <span class="type">String</span>,</span><br><span class="line">    created_at: <span class="type">u64</span>,</span><br><span class="line">    tags: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt;,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() {</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">metadata</span> = Arc::<span class="title function_ invoke__">new</span>(Metadata {</span><br><span class="line">        author: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">"Bob"</span>),</span><br><span class="line">        created_at: <span class="number">1616161616</span>,</span><br><span class="line">        tags: <span class="built_in">vec!</span>[<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">"important"</span>)],</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">doc1</span> = Document {</span><br><span class="line">        title: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">"Report"</span>),</span><br><span class="line">        content: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">"Some content..."</span>),</span><br><span class="line">        shared_metadata: metadata,</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">doc2</span> = doc1.<span class="title function_ invoke__">clone</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// doc2çš„titleå’Œcontentæ˜¯æ·±å…‹éš†çš„ç‹¬ç«‹å‰¯æœ¬</span></span><br><span class="line">    <span class="comment">// ä½†doc1å’Œdoc2å…±äº«åŒä¸€ä¸ªmetadata (Arc&lt;Metadata&gt;)</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œ<code>Document</code>çš„å…‹éš†æ˜¯æ··åˆè¡Œä¸ºï¼š</p>
<ul>
<li><code>title</code>å’Œ<code>content</code>å­—æ®µæ˜¯æ·±å…‹éš†ï¼ˆå®Œæ•´å‰¯æœ¬ï¼‰</li>
<li><code>shared_metadata</code>å­—æ®µæ˜¯æµ…å…‹éš†ï¼ˆå¼•ç”¨è®¡æ•°å¢åŠ ï¼‰</li>
</ul>
</blockquote>
<p>æ¯ä¸ª Handler é‡Œé™¤äº†å¿…è¦çš„èµ„æºï¼Œè¿˜æœ‰é€€å‡ºä¿¡å·ã€æ¯ä¸ªè¿æ¥çš„ä¿¡å·ã€‚åªæœ‰å½“æ‰€æœ‰è¿æ¥çš„ä¿¡å·éƒ½å…³é—­ï¼ŒæœåŠ¡å™¨æ‰ä¼šé€€å‡ºã€‚<br>
å½“æ¯ä¸ªè¿æ¥æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œå°±ä¼šå¼€å§‹å…³é—­è¿æ¥ï¼Œä¹Ÿå°±æ˜¯ Handler ä»»åŠ¡ã€‚</p>
<p>ä»»åŠ¡çš„ä¸»è¦å†…å®¹å°±æ˜¯è¯»å– Frameï¼Œä¸€å®šä¼šåœç•™åˆ°æ”¶åˆ°ä¸€ä¸ªå®Œæ•´çš„ Frameï¼Œæ‰è¿›è¡Œä¸‹ä¸€æ­¥ã€‚<br>
å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œå°±ä¼š Errï¼Œå¦‚æœå®¢æˆ·ç«¯æ”¿ç­–ç»ˆæ­¢è¿æ¥è¿”å›Noneã€‚<br>
æ¥ç€ Frame ä¼šè¢«<strong>è§£æ</strong>æˆå‘½ä»¤ï¼Œç„¶å<strong>æ‰§è¡Œ</strong>ï¼Œæ‰§è¡Œçš„ç»“æœä¼šè¢«åºåˆ—åŒ–æˆ Frameï¼Œç„¶åå†™å…¥åˆ°è¿æ¥é‡Œã€‚</p>
<p>è¿™é‡Œç”¨ enum æ¥è¡¨ç¤ºå‘½ä»¤ï¼Œç„¶åç”¨ match æ¥å¤„ç†ï¼Œè¿™æ˜¯ Rust çš„æ¨¡å¼åŒ¹é…ï¼Œå¾ˆå¥½çš„å®è·µï¼Œèƒ½é€‰æ‹©ä¸åŒçš„æˆå‘˜ï¼Œè¿™æ ·å„è‡ªå•ç‹¬å®ç°åŒåçš„å‘½ä»¤ï¼Œè¿™å°±ç±»ä¼¼æ¥å£äº†ã€‚</p>
<p>å¦å¤–æ¯ä¸ªå‘½ä»¤æœ‰ä¸åŒçš„ Frame ç»„è£…å½¢å¼å’Œè¿”å›å€¼å½¢å¼ã€‚</p>
<blockquote>
<p>è¿™é‡Œå°±æ¶‰åŠåˆ° rust çš„æ¨¡å—ç»„ç»‡äº†ï¼Œ</p>
<ol>
<li>ä¸€ä¸ªæ¨¡å—å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åå°±æ˜¯æ¨¡å—åï¼Œæ–‡ä»¶é‡Œçš„å†…å®¹å°±æ˜¯æ¨¡å—çš„å†…å®¹ã€‚</li>
<li>ä¸€ä¸ªæ¨¡å—å¯ä»¥åŒ…å«å¤šä¸ªç»“æ„ä½“ã€æšä¸¾ã€å‡½æ•°ç­‰ã€‚</li>
<li>ä¸€ä¸ªæ–‡ä»¶é‡Œå¯ä»¥åŒ…å«å¤šä¸ªæ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯ä»¥æ˜¯ç§æœ‰çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¬æœ‰çš„ã€‚è·¨æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯éšå«çš„æŠŠæ–‡ä»¶åå½“ä½œæ¨¡å—åï¼Œç„¶ååœ¨å…¶ä»–æ–‡ä»¶é‡Œå¼•ç”¨ã€‚ç›®å½•ä¹Ÿæ˜¯åŒç†ï¼Œç›®å½•åå°±æ˜¯æ¨¡å—åã€‚</li>
</ol>
<p>æ¨¡å—ç»„ç»‡æœ‰ <code>mod.rs</code> å’Œ ä¸ç›®å½•åŒåçš„rsæ–‡ä»¶ä¸¤ç§åšæ³•ï¼ŒRust 2018æ¨èä¹‹åæ¨èåè€…ï¼Œä½†æ˜¯å®é™…ä¸Šä¸¤è€…å·®åˆ«ä¸å¤§ï¼Œåªæ˜¯æ–‡ä»¶å‘½åä½ç½®ä¸åŒè€Œå·²ã€‚</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">â”œâ”€â”€ main.rs</span><br><span class="line">â””â”€â”€ models/</span><br><span class="line">    â”œâ”€â”€ mod.rs</span><br><span class="line">    â”œâ”€â”€ user.rs</span><br><span class="line">    â””â”€â”€ product.rs</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">â”œâ”€â”€ main.rs</span><br><span class="line">â”œâ”€â”€ models.rs</span><br><span class="line">â””â”€â”€ models/</span><br><span class="line">    â”œâ”€â”€ user.rs</span><br><span class="line">    â””â”€â”€ product.rs</span><br></pre></td></tr></tbody></table></figure>
<p>åŒºåˆ«åªæ˜¯ï¼Œ<code>mod.rs</code> æŒªåŠ¨åˆ°äº†åŒçº§ç›®å½•çš„ä¸ç›®å½•åŒåçš„rsæ–‡ä»¶é‡Œï¼Œä½ ä¸ç”¨åŠ¨é‡Œé¢çš„å†…å®¹ï¼Œrustä¼šè‡ªåŠ¨çš„å»ç›®å½•ä¸­æ‰¾å¯¹åº”æ–‡ä»¶ã€‚</p>
<p>ğŸ”¥ Rust å¯¼å…¥è¿˜æœ‰æŠ€å·§ï¼Œå¯ä»¥å…ˆå¯¼å…¥ï¼Œåœ¨è®¾ç½®Pubå“ªäº›ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> get;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> get::Get;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> publish;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> publish::Publish;</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h3 id="å®¢æˆ·ç«¯æ¨¡å—">å®¢æˆ·ç«¯æ¨¡å—</h3>
<p>Connection æ˜¯æœ€åŸºæœ¬çš„ï¼ŒåŒ…æ‹¬ TCPStream å’Œ Bufferã€‚æ¥ç€ç”¨æˆ·å‘½ä»¤è¡Œè¾“å…¥ç»„è£…æˆå¯¹åº”å‘½ä»¤ï¼Œå‘½ä»¤å†åºåˆ—åŒ–æˆ Frameï¼Œç„¶åå†™å…¥åˆ° Connection é‡Œã€‚<br>
æ¥ç€é˜»å¡ï¼Œç­‰å¾…æœåŠ¡å™¨è¿”å› frameã€‚ä½†æ˜¯è¦æ³¨æ„è¶…æ—¶ï¼Œè¿™é‡Œæ˜¯å¦‚æœå‘é€æˆåŠŸåï¼Œæ²¡æœ‰è€ƒè™‘å¯¹æ–¹è¶…æ—¶ã€‚æˆ‘ä»¬æ³¨é‡Šæ‰è¿”å›å†™å…¥çš„é€»è¾‘ï¼Œä¼šå‘ç°å®¢æˆ·ç«¯å¡ä½äº†ã€‚åé¢æˆ‘ä»¬è‡ªå·±æ¥ä¿®æ”¹ã€‚</p>
<p>Ping-&gt;Pongï¼Œ éƒ½æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›å³å¯ã€‚<br>
Get-&gt;Valueï¼Œå‘é€çš„æ˜¯ bulk æ•°ç»„ï¼Œè¿”å›Simpleã€Bulkã€Nulléƒ½æœ‰å¯èƒ½ã€‚<br>
Set-&gt;OKï¼Œè¿”å›çš„æ˜¯ Simpleã€‚</p>
<p>è®¢é˜…ä¼šéº»çƒ¦ä¸€äº›ï¼Œå­—ç¬¦ä¸²åˆ—è¡¨è¡¨ç¤ºè¦è®¢é˜…çš„å¤šä¸ªé¢‘é“ã€‚<br>
æœåŠ¡ç«¯é¦–å…ˆè¦è®°å½•å®¢æˆ·ç«¯è®¢é˜…äº†å“ªäº› channelï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ª channel åˆ›å»ºä¸€ä¸ª streamã€‚stream æ˜¯ç­‰å¾…åç»­æ¶ˆæ¯çš„æµï¼Œæ¶ˆæ¯é€šé“ï¼Œè¿™ä¸ªé€šé“æ˜¯rxï¼Œæ¥æ”¶ä¿¡æ¯ã€‚è€ŒæœåŠ¡ç«¯ä¼šåœ¨çŠ¶æ€æ•°æ®é‡Œè®°å½•å¯¹åº”çš„txï¼Œç­‰å¾…æœ‰å…¶ä»–å®¢æˆ·ç«¯Publishæ¶ˆæ¯åˆ°å¯¹åº”channelï¼Œç„¶åå¹¿æ’­ç»™rxã€‚</p>
<p>è¿™ä¸ªå®ç°æœ‰ä¸ªå¥½å¤„ï¼Œrx æ˜¯ä»çŠ¶æ€æ•°æ®åº“æ¥çš„ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æŒæœ‰å¯¹åº”çš„éƒ¨åˆ†ï¼Œé‚£ä¹ˆå°±å¯ä»¥åšåˆ°çŠ¶æ€æ•°æ®åº“å‘txå‘é€æ¶ˆæ¯ï¼Œç„¶åæ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯ã€‚è¿™å°±æ˜¯å¹¿æ’­æœºåˆ¶ã€‚</p>
<p>è¿™ä¸ª rx çš„ç±»å‹å¾ˆæœ‰æ„æ€ï¼Œloop ä¸ yield ä¸€èµ·ç”¨ï¼Œè¿™å°±æ˜¯ç”Ÿæˆå™¨ï¼Œä½†æ˜¯åŠ ä¸Š <code>async_stream::stream!</code> å°±æ˜¯å¼‚æ­¥çš„ç”Ÿæˆå™¨ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡ async-stream åŒ…æä¾›çš„ï¼Œå¯ä»¥å®ç°å¼‚æ­¥çš„æµã€‚ä¸è¿‡åŒæ­¥ä»£ç ä¸ä¼šç”¨ yieldï¼Œè€Œæ˜¯å®ç°ä¸€ä¸ª Iterator çš„ next æ–¹æ³•ã€‚æ‰€ä»¥è¿™ä¸ªè¯­æ³•å‡ ä¹æ˜¯åˆ›å»ºå¼‚æ­¥æµçš„æ ‡å‡†å†™æ³•ã€‚<br>
æ¯æ¬¡æ”¶åˆ°æ¶ˆæ¯ï¼Œå°± yield å‡ºå»ï¼Œç„¶åç­‰å¾…ä¸‹ä¸€æ¬¡æ¶ˆæ¯ï¼Œé€€å‡ºå°±è¿”å› Noneï¼Œè¿™å’Œ stream å®Œå…¨ç›¸åŒã€‚é‚£ä¹ˆæŒæœ‰è¿™ä¸ª loop çš„å˜é‡ï¼Œå°±å¯ä»¥å®ç° stream çš„åŠŸèƒ½ã€‚<br>
è€Œ <code>try_stream!</code> æ˜¯ async_stream æä¾›çš„å¦ä¸€ä¸ªé‡è¦å®ï¼Œå®ƒä¸ stream! ç±»ä¼¼ï¼Œä½†ä¸“é—¨ç”¨äºå¤„ç†å¯èƒ½å‡ºé”™çš„åœºæ™¯ã€‚å®ƒè¿”å›çš„æµä¸­çš„å…ƒç´ ç±»å‹æ˜¯ Result&lt;T, E&gt;ï¼Œå¹¶ä¸”åœ¨å®å†…éƒ¨å¯ä»¥ä½¿ç”¨ ? æ“ä½œç¬¦è¿›è¡Œé”™è¯¯ä¼ æ’­ã€‚è¿™å¯¹äºåƒç½‘ç»œæ“ä½œã€IO è¯»å†™ç­‰å¯èƒ½å¤±è´¥çš„å¼‚æ­¥æ“ä½œç‰¹åˆ«æœ‰ç”¨ã€‚<br>
å½“æˆ‘ä»¬ä½¿ç”¨ try_stream! æ—¶ï¼Œå†…éƒ¨çš„é”™è¯¯ä¼šè¢«è‡ªåŠ¨åŒ…è£…æˆ Result ç±»å‹å¹¶å‘ä¸Šä¼ æ’­ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">rx</span> = db.<span class="title function_ invoke__">subscribe</span>(channel_name.<span class="title function_ invoke__">clone</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Subscribe to the channel.</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">rx</span> = <span class="type">Box</span>::<span class="title function_ invoke__">pin</span>(async_stream::stream! {</span><br><span class="line">    <span class="keyword">loop</span> {</span><br><span class="line">        <span class="keyword">match</span> rx.<span class="title function_ invoke__">recv</span>().<span class="keyword">await</span> {</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(msg) =&gt; <span class="keyword">yield</span> msg,</span><br><span class="line">            ...</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line"><span class="comment">// Track subscription in this client's subscription set.</span></span><br><span class="line">subscriptions.<span class="title function_ invoke__">insert</span>(channel_name.<span class="title function_ invoke__">clone</span>(), rx); <span class="comment">//  &amp;mut StreamMap&lt;String, Messages&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨åº•å±‚å®ç°ä¸Šï¼Œasync_stream é€šè¿‡å·§å¦™çš„æ–¹å¼è§£å†³äº†å¼‚æ­¥çŠ¶æ€ç®¡ç†çš„é—®é¢˜ã€‚å®ƒä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¥ä¿å­˜çŠ¶æ€ï¼Œé¿å…äº†æ‰‹åŠ¨å®ç° Stream ç‰¹æ€§æ—¶éœ€è¦ä½¿ç”¨ unsafe ä»£ç å¤„ç†è‡ªå¼•ç”¨ç»“æ„çš„å¤æ‚æ€§ã€‚è¿™ä½¿å¾—å¼€å‘è€…å¯ä»¥ç”¨çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç çš„æ–¹å¼ï¼ˆä½¿ç”¨ <code>async/await</code> å’Œ yieldï¼‰æ¥ç¼–å†™å¼‚æ­¥æµï¼Œè€Œä¸å¿…å…³å¿ƒåº•å±‚çš„å¼‚æ­¥çŠ¶æ€æœºå®ç°ç»†èŠ‚ã€‚</p>
<p>è¿˜æœ‰ä¸ªæœ‰æ„æ€çš„åœ°æ–¹ï¼Œå°±æ˜¯ stream çš„ç±»å‹ <code>Box::pin(...)</code>ï¼Œè¿™åˆ›å»ºä¸€ä¸ªå †åˆ†é…çš„ <code>stream</code>ï¼Œè¿™æ˜¯å› ä¸º <code>async_stream::stream!</code> åˆ›å»ºçš„ stream ç±»å‹å’Œå¤§å°æ˜¯ä¸ç¡®å®šçš„ï¼Œç¼–è¯‘æ—¶æ‰äº§ç”Ÿçš„ã€‚</p>
<p>è¿™æ ·å°è£…ä¸€å±‚Boxï¼Œå°±å¯ä»¥å½“ä½œä¸€ä¸ªå›ºå®šå¤§å°çš„ç±»å‹æ¥ä½¿ç”¨äº†ã€‚è®°ä½ï¼Œ<strong>Rust æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œæ¯ä¸ªå˜é‡éƒ½æœ‰å›ºå®šçš„ç±»å‹å’Œå¤§å°ï¼Œæ— æ³•ç¡®å®šå¤§å°çš„ç±»å‹ä¸€å®šæ˜¯åœ¨å †ä¸Šï¼Œè€Œä¸”ç”¨æ ˆä¸Šçš„æŒ‡é’ˆå¼•ç”¨</strong>ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å†…å­˜å®‰å…¨ã€‚</p>
<p>è¿™é‡Œçš„ pin ä¹Ÿæ˜¯æœ‰å­¦é—®çš„ï¼Œå¼‚æ­¥æœ¬è´¨ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª Futureï¼Œè¡¨ç¤ºè¿˜æ²¡æœ‰å®Œæˆçš„è®¡ç®—ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Š traitã€‚åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œæ¯ä¸ªå¼‚æ­¥ä»»åŠ¡è½¬æ¢æˆçŠ¶æ€æœºï¼Œæ¯ä¸ªçŠ¶æ€å°±æ˜¯å¼‚æ­¥ä»»åŠ¡çš„ä¸€ä¸ªç­‰å¾…ç‚¹ã€‚è¿™ä¸ªçŠ¶æ€æœºå¯èƒ½åŒ…æ‹¬å¯¹æ•°æ®çš„å¼•ç”¨ï¼Œå½“è¿™ä¸ª Future è¢«è°ƒåº¦åˆ°å…¶ä»–çº¿ç¨‹ï¼Œå†…å­˜ä½ç½®å°±å¯èƒ½å˜åŒ–ï¼Œå¯¼è‡´å¼•ç”¨å¤±æ•ˆã€‚æ‰€ä»¥éœ€è¦ pin ä¿è¯å†…å­˜ä½ç½®ä¸å˜ï¼Œè¿™æ ·å°±å¯ä»¥å®‰å…¨çš„åœ¨å¤šçº¿ç¨‹ä¹‹é—´ä¼ é€’ Futureã€‚</p>
<p>Box::pin æ˜¯æ ‡å‡†åº“æä¾›çš„æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå †åˆ†é…çš„ã€è¢«é’‰ä½çš„å€¼ã€‚tokio::pin! æ˜¯ tokio æä¾›çš„å®ï¼Œç”¨äºåœ¨æ ˆä¸Šé’‰ä½å€¼ã€‚æœ€é‡è¦çš„åŒºåˆ«åœ¨äºtokio::pin! åˆ†é…åœ¨æ ˆä¸Šï¼Œæ›´é«˜æ•ˆï¼Œæ— éœ€å †åˆ†é…ï¼Œä½†æ˜¯ç”Ÿå‘½å‘¨æœŸå—é™äºå½“å‰ä½œç”¨åŸŸï¼Œæ— æ³•è·¨å‡½æ•°è¾¹ç•Œä¼ é€’ã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™éœ€è¦Pinå‘¢ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ streamï¼Œå› ä¸º stream æœ¬èº«å°±æ˜¯ä¸ºäº†ç­‰å¾…å¼‚æ­¥ä»»åŠ¡çš„ç»“æœï¼Œæ‰€ä»¥å®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªFutureã€‚</p>
<p>è¿˜æœ‰å°±æ˜¯è‡ªå¼•ç”¨çš„ç»“æ„ï¼Œæ¯”å¦‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SelfReferential</span> {</span><br><span class="line">    data: <span class="type">String</span>,</span><br><span class="line">    <span class="comment">// This would normally be unsafe without Pin</span></span><br><span class="line">    reference: *<span class="keyword">const</span> <span class="type">String</span>,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸‹é¢å‡½æ•°çš„è¿”å›å€¼ç±»å‹ä¹Ÿæ˜¯ rust çš„é‡è¦çŸ¥è¯†ç‚¹ã€‚ å‰é¢çš„ rx æ¨ç†å‡ºçš„çš„ç±»å‹æ˜¯ <code>Pin&lt;Box&lt;AsyncStream&lt;Bytes, impl Future&lt;Output = ()&gt;&gt;&gt;&gt;</code>ï¼Œå®é™…å®šä¹‰çš„ç±»å‹æ˜¯ <code>Pin&lt;Box&lt;dyn Stream&lt;Item = Bytes&gt; + Send&gt;&gt;</code>ï¼Œä¸‹é¢å‡½æ•°è¿”å›çš„ç±»å‹æ˜¯ <code>impl Stream&lt;Item = crate::Result&lt;Message&gt;&gt;</code>ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸ç”¨çš„å†™æ³• <code>&lt;Box&lt;dyn _&gt;&gt;</code> å’Œ <code>impl _</code>ï¼Œè¿™é‡Œå°±æ˜¯åŠ¨æ€åˆ†å‘å’Œé™æ€åˆ†å‘çš„åŒºåˆ«ï¼ŒåŠ¨æ€åˆ†å‘æ˜¯åœ¨è¿è¡Œæ—¶ç¡®å®šç±»å‹ï¼Œå¯ä»¥è¿”å›ä¸åŒçš„å…·ä½“ç±»å‹å®ç°ï¼ˆå¤šæ€ï¼‰ï¼Œæœ‰è½»å¾®çš„æ€§èƒ½å¼€é”€ï¼Œç”¨Boxå®ç°è¿”å›å€¼ç±»å‹å¤§å°å›ºå®šï¼ˆå°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆå¤§å°ï¼‰ã€‚è€Œé™æ€åˆ†å‘æ˜¯åœ¨ç¼–è¯‘æ—¶ç¡®å®šç±»å‹ï¼Œåªèƒ½è¿”å›å•ä¸€å…·ä½“ç±»å‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚<code>into_stream</code> ç”¨é™æ€åˆ†å‘çš„åŸå› æ˜¯å®ƒä¸“é—¨å¤„ç†å›ºå®šçš„ Message ç±»å‹ã€‚è€Œå‰é¢åŠ¨æ€åˆ†å‘æ˜¯å› ä¸ºéœ€è¦å¤„ç†å¤šç§å¯èƒ½çš„ Stream å®ç°ï¼Œè€Œè¿™äº›å®ç°åœ¨ç¼–è¯‘æ—¶å¯èƒ½å¹¶ä¸ç¡®å®šã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">into_stream</span>(<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Stream</span>&lt;Item = crate::<span class="type">Result</span>&lt;Message&gt;&gt; {</span><br><span class="line">    try_stream! {</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(message) = <span class="keyword">self</span>.<span class="title function_ invoke__">next_message</span>().<span class="keyword">await</span>? {</span><br><span class="line">            <span class="keyword">yield</span> message;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å®¢æˆ·ç«¯çš„è™½æœ‰è®¢é˜…çš„rxéƒ½å­˜å‚¨åœ¨ <code>subscriptions = StreamMap::new();</code> é‡Œäº†ï¼Œå°±æ˜¯å‰é¢æåˆ°çš„ str-&gt;rx çš„æ˜ å°„ã€‚ä»–çš„å¥½å¤„æ˜¯ï¼Œä»»ä½•ä¸€ä¸ªrxæ”¶åˆ°æ¶ˆæ¯ï¼Œsubscriptions.next() å°±ä¼šè¿”å›è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸ç”¨è‡ªå·±æ‰‹åŠ¨çš„å†™ä¸ª select æ¥ç­‰å¾…å¤šä¸ªrxã€‚</p>
<p>å¦å¤–ç”¨æˆ·å¯èƒ½å†æ¬¡è®¢é˜…æ›´å¤šçš„é¢‘é“ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ç»§ç»­å¢åŠ  channelsï¼Œç„¶åè§¦å‘å¢åŠ  rxã€‚</p>
<p>å¦‚æœç”¨æˆ·è¦å–æ¶ˆè®¢é˜…ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯å°±è¦åˆ é™¤å¯¹åº”çš„ rxï¼Œè¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ rx æ˜¯å¼‚æ­¥çš„ï¼Œå¯èƒ½æ­£åœ¨ç­‰å¾…æ¶ˆæ¯ï¼Œè¿™æ—¶å€™åˆ é™¤äº†ï¼Œå°±ä¼šå¯¼è‡´ rx æ— æ³•æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä¸­æ–­rxï¼Œè¿™æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå› ä¸ºç”¨æˆ·å–æ¶ˆè®¢é˜…ï¼Œå°±ä¸åº”è¯¥å†æ¥æ”¶åˆ°æ¶ˆæ¯äº†ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ publish çš„å®ç°ï¼Œæ˜¯æ€ä¹ˆå‘é€ç»™ channel å¯¹åº”çš„ tx çš„ã€‚è¿™ä¸ªæ“ä½œå°±ç›¸å½“ç®€å•äº†ï¼Œå› ä¸ºåªç®¡å‘å¸ƒå°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">subscribe_to_channel</span>(</span><br><span class="line">    channel_name: <span class="type">String</span>,</span><br><span class="line">    subscriptions: &amp;<span class="keyword">mut</span> StreamMap&lt;<span class="type">String</span>, Messages&gt;,</span><br><span class="line">    db: &amp;Db,</span><br><span class="line">    dst: &amp;<span class="keyword">mut</span> Connection,</span><br><span class="line">) <span class="punctuation">-&gt;</span> crate::<span class="type">Result</span>&lt;()&gt; {</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">rx</span> = db.<span class="title function_ invoke__">subscribe</span>(channel_name.<span class="title function_ invoke__">clone</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Subscribe to the channel.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rx</span> = <span class="type">Box</span>::<span class="title function_ invoke__">pin</span>(async_stream::stream! {</span><br><span class="line">        <span class="keyword">loop</span> {</span><br><span class="line">            <span class="keyword">match</span> rx.<span class="title function_ invoke__">recv</span>().<span class="keyword">await</span> {</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(msg) =&gt; <span class="keyword">yield</span> msg,</span><br><span class="line">                <span class="comment">// If we lagged in consuming messages, just resume.</span></span><br><span class="line">                <span class="title function_ invoke__">Err</span>(broadcast::error::RecvError::<span class="title function_ invoke__">Lagged</span>(_)) =&gt; {},</span><br><span class="line">                <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="keyword">break</span>,</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Track subscription in this client's subscription set.</span></span><br><span class="line">    subscriptions.<span class="title function_ invoke__">insert</span>(channel_name.<span class="title function_ invoke__">clone</span>(), rx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Respond with the successful subscription</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">response</span> = <span class="title function_ invoke__">make_subscribe_frame</span>(channel_name, subscriptions.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    dst.<span class="title function_ invoke__">write_frame</span>(&amp;response).<span class="keyword">await</span>?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ”¹è¿›">æ”¹è¿›</h2>
<blockquote>
<p>æ”¹åŠ¨è§ï¼š <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/learnerLj/mini-redis/commit/dd18c65b17347e1986efc2df30f9d9f73f595086">https://github.com/learnerLj/mini-redis/commit/dd18c65b17347e1986efc2df30f9d9f73f595086</a></p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘æ‰“ç®—åœ¨è¿™ä¸ªé¡¹ç›®çš„åŸºç¡€ä¸Šè¿›è¡Œä¸€äº›æ‰©å±•ã€‚è¿™é‡Œæœ‰ä¸ªå…³é”®ï¼Œå°±æ˜¯ä¸ä¼šæ¸…ç†æ‰è¿‡æœŸçš„ broadcast::Senderã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè€ƒè™‘ Sender æ˜¯å¦çŸ¥æ™“è‡ªå·±æœ‰rxå‘¢ï¼Ÿè¿™ä¸ªæ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºæ²¡æœ‰ç›´æ¥çš„æ–¹æ³•æ¥æ£€æµ‹ï¼Œåªèƒ½å‘é€æ¶ˆæ¯å»å°è¯•ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pub_sub: HashMap&lt;<span class="type">String</span>, broadcast::Sender&lt;Bytes&gt;&gt;,</span><br></pre></td></tr></tbody></table></figure>
<p>é‚£æˆ‘æˆ‘ä»¬å¢åŠ è¿™ä¹ˆä¸ªæœºåˆ¶ã€‚ä¸‹é¢2ä¸ªæ¡ä»¶éƒ½ä¼šæ¸…ç†æ‰å¯¹åº”çš„ Senderã€‚</p>
<ol>
<li>
<p>é€šè¿‡ TCP è¿æ¥çš„çŠ¶æ€æ¥ç®¡ç†è®¢é˜…çš„æœ‰æ•ˆæ€§ã€‚å¦‚æœå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°å¹¶æ¸…ç†ç›¸åº”çš„èµ„æºã€‚æ³¨æ„å¿ƒè·³æœºåˆ¶æ²¡æœ‰ä½œç”¨ï¼Œè¿™é‡Œæ˜¯TCPè¿æ¥ï¼Œä¸€èˆ¬å¿ƒè·³æœºåˆ¶æ˜¯ç”¨äºUDPï¼Œæ£€éªŒæŸäº›è®°å½•æ˜¯å¦è¿˜æœ‰æ•ˆã€‚</p>
</li>
<li>
<p>Senderå¢åŠ ä¸€ä¸ªå­—æ®µï¼Œæ˜¯rxçš„è®¡æ•°ã€‚å¯¹åº”æ‰çº¿æˆ–è€…ä¸»åŠ¨å–æ¶ˆè®¢é˜…ï¼Œéƒ½ä¼šå‡å°‘è®¡æ•°ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„ rxï¼Œå°±æ¸…ç†æ‰å¯¹åº”çš„ Senderã€‚è¿™ä¸ªæ˜¯ä¸ºäº†é˜²æ­¢å®¢æˆ·ç«¯å–æ¶ˆè®¢é˜…ï¼Œä½†æ˜¯æœåŠ¡ç«¯æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå¯¼è‡´çš„å†…å­˜æ³„æ¼ã€‚</p>
</li>
</ol>
<p>å…·ä½“è¯´ï¼Œè®¢é˜…æ—¶ï¼Œè¦æ›´æ–°å¯¹åº”å­—æ®µã€‚é‡å¤è®¢é˜…å·²ç»å­˜åœ¨çš„ channelï¼Œä¹Ÿè¦åˆ·æ–°æ´»è·ƒæ—¶é—´ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Entry::<span class="title function_ invoke__">Occupied</span>(e) =&gt;</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">channel_state</span> = e.<span class="title function_ invoke__">into_mut</span>();</span><br><span class="line">        channel_state.receiver_count += <span class="number">1</span>;</span><br><span class="line">        channel_state.last_activity = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line">        channel_state.sender.<span class="title function_ invoke__">subscribe</span>()</span><br><span class="line"></span><br><span class="line">    },</span><br><span class="line">    Entry::<span class="title function_ invoke__">Vacant</span>(e) =&gt; {</span><br><span class="line">        <span class="comment">// No broadcast channel exists yet, so create one.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// The channel is created with a capacity of `1024` messages. A</span></span><br><span class="line">        <span class="comment">// message is stored in the channel until **all** subscribers</span></span><br><span class="line">        <span class="comment">// have seen it. This means that a slow subscriber could result</span></span><br><span class="line">        <span class="comment">// in messages being held indefinitely.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// When the channel's capacity fills up, publishing will result</span></span><br><span class="line">        <span class="comment">// in old messages being dropped. This prevents slow consumers</span></span><br><span class="line">        <span class="comment">// from blocking the entire system.</span></span><br><span class="line">        <span class="keyword">let</span> (tx, rx) = broadcast::<span class="title function_ invoke__">channel</span>(<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">channel_state</span> = ChannelState {</span><br><span class="line">            sender: tx,</span><br><span class="line">            receiver_count: <span class="number">1</span>,</span><br><span class="line">            last_activity: Instant::<span class="title function_ invoke__">now</span>(),</span><br><span class="line">        };</span><br><span class="line">        e.<span class="title function_ invoke__">insert</span>(channel_state);</span><br><span class="line">        rx</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p>å–æ¶ˆè®¢é˜…çš„æ—¶å€™æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯ç”±äºä¹‹å‰ db æ¨¡å—æ²¡æœ‰è¿™éƒ¨ä»½é€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦ä» unsubscribe å‘½ä»¤ï¼Œä¸€ç›´æ”¹åˆ° dbã€‚ä¹‹å‰åªæ˜¯ä» subscriptions é‡Œåˆ é™¤è¿™ä¸ª channel-&gt;stream æ˜ å°„ï¼Œè¿™æ ·subscriptions.next() å°±ä¸ä¼šä»åˆ é™¤äº†çš„rxè¿”å›æ•°æ®äº†ã€‚ä½†æ˜¯è¿™æ¬¡æˆ‘ä»¬è¦dbé‡Œä¹Ÿæ”¹ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸ªæœ‰è¶£çš„ç‚¹ï¼Œå‚æ•°db æ²¡æœ‰mutï¼Œä½†æ˜¯å®é™…è®¢é˜…æ˜¯ä¿®æ”¹äº† dbçš„çŠ¶æ€çš„ï¼Œè¿™æ˜¯å¦çŸ›ç›¾äº†å‘¢ï¼Ÿæ²¡æœ‰ï¼Œå› ä¸º Mutex æ˜¯Refcellçš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ä¹Ÿå®ç°äº†å†…éƒ¨å¯å˜è¡Œã€‚Db ç»“æ„ä½“åŒ…å«ä¸€ä¸ª Arc<shared>ï¼Œè€Œ Shared ç»“æ„ä½“åŒ…å«ä¸€ä¸ª Mutex<state>ã€‚<code>let mut state = self.shared.state.lock().unwrap();</code> å°±è‡ªåŠ¨çš„å˜æˆå¯å˜çš„äº†ã€‚è¿™é‡Œå°±æ˜¯å¾ˆå¥½çš„ä¾‹å­ï¼Œæˆ‘ä»¬çš„Dbä¸æƒ³ä»å¤´åˆ°å°¾éƒ½æ˜¯å¯å˜å‚æ•°ä¼ è¿›å»ï¼Œåˆ°äº† state å­—æ®µå°±å¯å˜äº†ã€‚</state></shared></p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">subscribe_to_channel</span>(</span><br><span class="line">    channel_name: <span class="type">String</span>,</span><br><span class="line">    subscriptions: &amp;<span class="keyword">mut</span> StreamMap&lt;<span class="type">String</span>, Messages&gt;,</span><br><span class="line">    db: &amp;Db,</span><br><span class="line">    dst: &amp;<span class="keyword">mut</span> Connection,</span><br><span class="line">) <span class="punctuation">-&gt;</span> crate::<span class="type">Result</span>&lt;()&gt; {</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">rx</span> = db.<span class="title function_ invoke__">subscribe</span>(channel_name.<span class="title function_ invoke__">clone</span>());</span><br></pre></td></tr></tbody></table></figure>
<p>db å¢åŠ ä¸€ä¸ªå®ç°ï¼Œå½“æ‰€æœ‰è®¢é˜…è¢«å–æ¶ˆäº†ï¼Œå°±è¦åˆ é™¤è¿™ä¸ªè®¢é˜…ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">unsubscribe</span>(&amp;<span class="keyword">self</span>, key: &amp;<span class="type">str</span>) {</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">state</span> = <span class="keyword">self</span>.shared.state.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(channel_state) = state.pub_sub.<span class="title function_ invoke__">get_mut</span>(key) {</span><br><span class="line">            channel_state.receiver_count -= <span class="number">1</span>;</span><br><span class="line">            channel_state.last_activity = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> channel_state.receiver_count == <span class="number">0</span> {</span><br><span class="line">                state.pub_sub.<span class="title function_ invoke__">remove</span>(key);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p>ä½†æ˜¯ä¹Ÿå¯èƒ½å­˜åœ¨ä¸€äº›å®¢æˆ·ç«¯ï¼Œå·²ç»æ‰çº¿äº†ï¼Œä½†æ˜¯è®¢é˜…è¿˜å­˜åœ¨ï¼Œé‚£éœ€è¦åœ¨æ‰çº¿çš„æ—¶å€™ï¼Œå¢åŠ å–æ¶ˆè®¢é˜…çš„é€»è¾‘ã€‚ä¸­æ–­æ—¶ <code>dst.read_frame()</code> ä¼šè¿”å› noneï¼Œé‚£ä¹ˆæ‰€æœ‰è®¢é˜…éƒ½åº”è¯¥åˆ é™¤ï¼Œé€šçŸ¥serverå¯¹åº”è®¡æ•°æ”¹å˜ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">res = dst.<span class="title function_ invoke__">read_frame</span>() =&gt; {</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">frame</span> = <span class="keyword">match</span> res? {</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(frame) =&gt; frame,</span><br><span class="line">        <span class="comment">// This happens if the remote client has disconnected.</span></span><br><span class="line">        <span class="literal">None</span> =&gt; {</span><br><span class="line">            subscriptions.<span class="title function_ invoke__">keys</span>().for_each(|channel_name| {</span><br><span class="line">                db.<span class="title function_ invoke__">unsubscribe</span>(channel_name);</span><br><span class="line">            });</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">        }</span><br><span class="line">    };</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸ºäº†éªŒè¯æˆ‘ä»¬çš„è®¢é˜…ç®¡ç†æ˜¯å¦çœŸçš„èµ·æ•ˆï¼Œæˆ‘ä»¬å¢åŠ  debug traceã€‚æ¥ç€æŠŠ <code>mod.rs</code> çš„æ¨¡å¼ï¼Œæˆ‘ä»¬æ”¹æˆç°ä»£çš„æ¨¡å¼ã€‚</p>
<h2 id="å­¦ä¹ é¡¹ç›®ç»“æ„">å­¦ä¹ é¡¹ç›®ç»“æ„</h2>
<p>è¿˜æœ‰é¡¹ç›®çš„å¸ƒå±€ï¼Œæˆ‘ä»¬å‘ç° example æ–‡ä»¶å¤¹ä¸‹ï¼Œä¹Ÿèƒ½å¯¼å…¥æœ¬åœ°çš„ mini_redisï¼Œè¿™è¯´æ˜å¯»æ‰¾ä¾èµ–åº“æ—¶ï¼ŒCargo é¦–å…ˆä¼šè¯»å–é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ Cargo.toml æ–‡ä»¶ï¼Œå®ƒä¼šæ£€æŸ¥ [package] éƒ¨åˆ†çš„ name å­—æ®µï¼Œè¿™å®šä¹‰äº†é¡¹ç›®/åº“çš„åç§°ã€‚å½“åœ¨ä»£ç ä¸­ä½¿ç”¨ use mini_redis è¿™æ ·çš„å¯¼å…¥è¯­å¥æ—¶ï¼ŒCargo ä¼šé¦–å…ˆæ£€æŸ¥è¿™ä¸ªåç§°æ˜¯å¦ä¸å½“å‰é¡¹ç›®åç§°åŒ¹é…<br>
å¦‚æœåŒ¹é…ï¼Œå®ƒä¼šä¼˜å…ˆä½¿ç”¨å½“å‰é¡¹ç›®çš„åº“ä»£ç ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œæ‰ä¼šå»æŸ¥æ‰¾å¤–éƒ¨ä¾èµ–ã€‚</p>
<p>æˆ‘ä»¬è¿˜å‘ç°äº†è¿è¡Œå‘½ä»¤ <code>cargo run --example sub</code> ç»“æ„ç‰¹æ®Šï¼Œè¿™æ˜¯è¿è¡Œä¸€çº§ç›®å½•ä¸‹çš„ subæ¨¡å—ï¼Œå¦‚æœæ˜¯sub.rså•ä¸ªæ–‡ä»¶ï¼Œå°±æ˜¯é‡Œé¢çš„mainå‡½æ•°ã€‚å¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œé‚£ä¹ˆå°±æ˜¯è¿è¡Œæ•´ä¸ªæ¨¡å—ï¼Œä¸€èˆ¬å…¥å£ <code>example/sub/main.rs</code>ã€‚</p>
<p>è¿™é‡Œçš„é¡¹ç›®å±‚çº§ï¼Œåªè¦ä½ åœ¨é¡¹ç›®ç›®å½•å†…ï¼Œå°±ä¸ä¼šå—åˆ°å½“å‰è·¯å¾„çš„å½±å“ï¼Œä½ å¯ä»¥åœ¨é¡¹ç›®çš„ä»»ä½•åœ°æ–¹è¿è¡Œï¼Œä¼šè‡ªåŠ¨å¯»æ‰¾ã€‚ä½†æ˜¯ Rust å¯¹äºå¤§å‹é¡¹ç›®ï¼Œæœ‰ä¸€ä¸ª"å·¥ä½œç©ºé—´"(Workspace)ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦æŒ‡å®šé¡¹ç›®äº†ã€‚åœ¨ workspace æ ¹ç›®å½•è¿è¡Œï¼šéœ€è¦æŒ‡å®šåŒ… cargo run --package project-a --example sub</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">workspace/</span><br><span class="line">â”œâ”€â”€ Cargo.toml  # å·¥ä½œç©ºé—´é…ç½®</span><br><span class="line">â”œâ”€â”€ project-a/</span><br><span class="line">â”‚   â”œâ”€â”€ Cargo.toml</span><br><span class="line">â”‚   â””â”€â”€ examples/</span><br><span class="line">â”‚       â””â”€â”€ sub.rs</span><br><span class="line">â””â”€â”€ project-b/</span><br><span class="line">    â””â”€â”€ Cargo.toml</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚ä½•åˆ¤æ–­æ˜¯ä¸€ä¸ª"å·¥ä½œç©ºé—´"(Workspace)å‘¢ï¼Ÿæ ¹ç›®å½•æœ‰ä¸€ä¸ªä¸» Cargo.tomlï¼Œå®šä¹‰å·¥ä½œç©ºé—´å’Œæˆå‘˜é¡¹ç›®ã€‚æ¯”å¦‚rethé¡¹ç›®ï¼Œcargo buildã€cargo test ç­‰å‘½ä»¤æ—¶è®¾ç½®äº†é»˜è®¤åŒ…ï¼Œ</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[workspace]</span><br><span class="line">members = [</span><br><span class="line">    "bin/reth-bench/",</span><br><span class="line">    "bin/reth/",</span><br><span class="line">    "crates/chain-state/",</span><br><span class="line">    ...</span><br><span class="line">]</span><br><span class="line">efault-members = ["bin/reth"]</span><br><span class="line">exclude = ["book/sources", "book/cli"]</span><br></pre></td></tr></tbody></table></figure>
<p>é¡¹ç›®é‡Œè¿˜æœ‰ binç›®å½•ï¼Œç”¨æ¥ç”¨ä¸Šå„ä¸ªæ¨¡å—çš„åŠŸèƒ½ï¼Œå®Œæˆè¿™ä¸ªå·¥å…·ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯è½¯ä»¶çš„å…¥å£ã€‚è¿™é‡Œæ˜¯å› ä¸ºæœ‰å¤šä¸ªè½¯ä»¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŸå› ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªï¼Œä¸€èˆ¬å¯»æ‰¾ src/main.rs æˆ–è€… src/bin/main.rs ä½œä¸ºé»˜è®¤å…¥å£ã€‚</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[[bin]]</span><br><span class="line">name = "mini-redis-cli"</span><br><span class="line">path = "src/bin/cli.rs"</span><br><span class="line"></span><br><span class="line">[[bin]]</span><br><span class="line">name = "mini-redis-server"</span><br><span class="line">path = "src/bin/server.rs"</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äºç®€å•çš„é¡¹ç›®ï¼Œç”¨è¿™æ ·çš„å¸ƒå±€è¶³å¤Ÿäº†ã€‚workspaceå°±å•ç‹¬å­¦ä¹ ã€‚</p>
<p>å†çœ‹é¡¹ç›®å¯¼å‡ºçš„éƒ¨åˆ†ï¼Œéƒ½åœ¨ src/lib.rs ä¸­ã€‚æ¯ä¸ªå­æ¨¡å—å¯¼å‡ºçš„å‡½æ•°ï¼Œå°±åœ¨<code>mod.rs</code>æˆ–è€…ä¸ç›®å½•åŒåçš„rsæ–‡ä»¶ã€‚</p>
<h2 id="å­¦ä¹ æµ‹è¯•">å­¦ä¹ æµ‹è¯•</h2>
<p>ä¸‹é¢æ˜¯å…¸å‹çš„æµ‹è¯•ï¼Œå¯¹äºç”¨åˆ° async çš„å‡½æ•°ï¼Œéƒ½è¦ç”¨ <code>#[tokio::test]</code> ä»£æ›¿ <code>#[test]</code></p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A PING PONG test without message provided.</span></span><br><span class="line"><span class="comment">/// It should return "PONG".</span></span><br><span class="line">#<span class="meta">#[tokio::test]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">ping_pong_without_message</span>() {</span><br><span class="line">    <span class="keyword">let</span> (addr, _) = <span class="title function_ invoke__">start_server</span>().<span class="keyword">await</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">client</span> = Client::<span class="title function_ invoke__">connect</span>(addr).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pong</span> = client.<span class="title function_ invoke__">ping</span>(<span class="literal">None</span>).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="string">b"PONG"</span>, &amp;pong[..]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>æµ‹è¯•çš„æ–­è¨€ï¼Œé™¤äº† assert_eq! è¿˜æœ‰ <code>#[should_panic]</code>ï¼Œæ ‡è®°åœ¨æµ‹è¯•å‡½æ•°ä¸Šï¼Œè¡¨ç¤ºéœ€è¦è§¦å‘panicã€‚</p>
<p>æœ‰æ—¶å€™éœ€è¦ä¾¿è¾¹å†™ä»£ç è¾¹æµ‹è¯•ï¼Œä½†æ˜¯æˆ‘ä»¬åˆä¸å¸Œæœ›æµ‹è¯•ç”¨ä¾‹ä¹Ÿç¼–è¯‘è¿›ç¨‹åºï¼Œé‚£ä¹ˆåˆ›å»ºä¸€ä¸ª testæ¨¡å—ï¼Œç„¶å <code>#[cfg(test)]</code> æ ‡è®°å®ƒï¼Œè¿™æ ·ä»…åœ¨æµ‹è¯•æ„å»ºæ—¶åŒ…å«çš„ä»£ç å—ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests {</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">it_works</span>() {</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="number">2</span> + <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¦è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œç›´æ¥ <code>cargo test</code>ï¼Œä¼šå¯»æ‰¾é¡¹ç›®ä¸­æ‰€æœ‰æ ‡è®°ä¸ºæµ‹è¯•çš„ä»£ç ï¼Œè€Œä¸ä»…ä»…æ˜¯ tests ç›®å½•ä¸‹çš„æµ‹è¯•ã€‚æ ‡è®°ä¸ºæµ‹è¯•æ˜¯æŒ‡ï¼š</p>
<ol>
<li>æ ‡è®°ä¸º <code>#[test]</code> çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¿…é¡»è¿”å› () å¹¶ä¸”ä¸èƒ½æ¥å—ä»»ä½•å‚æ•°ã€‚</li>
<li>æ ‡è®°ä¸º <code>#[tokio::test]</code> æˆ–å…¶ä»–è‡ªå®šä¹‰æµ‹è¯•å®çš„å‡½æ•°ã€‚</li>
<li>åœ¨ <code>#[cfg(test)]</code> æ¨¡å—ä¸­çš„æµ‹è¯•å‡½æ•°ã€‚</li>
</ol>
<p>å¦‚æœä½ åªæƒ³è¿è¡Œ tests ç›®å½•ä¸‹çš„æµ‹è¯•ï¼Œå•ä¸ªæ¨¡å— <code>cargo test --test</code>ã€‚å¦‚æœä¸åœ¨ <code>tests</code> ç›®å½•ä¸‹ï¼Œé‚£ä¹ˆå°±æŒ‰ç…§æ¨¡å—é¡ºåºå»æ‰¾ï¼Œæ¯”å¦‚ <code>cargo test crate::models::user::test_user_validation</code>ã€‚ä¹Ÿå¯ä»¥ç®€å•åœ°æä¾›æµ‹è¯•å‡½æ•°çš„åç§°ï¼Œå¦‚æœå®ƒåœ¨é¡¹ç›®ä¸­æ˜¯å”¯ä¸€çš„ <code>cargo test test_user_validation</code>ã€‚è¿™é‡Œçš„åå­—éƒ½æ˜¯å¯ä»¥<strong>æ­£åˆ™åŒ¹é…</strong>çš„ã€‚</p>
<p>å¦‚æœä½ éœ€è¦çœ‹åˆ°æµ‹è¯•ä¸­çš„ println! è¾“å‡ºï¼Œå¯ä»¥æ·»åŠ  â€“ --nocapture å‚æ•°ã€‚æ¯”å¦‚ <code>cargo test --test server key_value_get_set -- --nocapture</code>ã€‚</p>
<p><code>--show-output</code> å‚æ•°åªä¼šæ˜¾ç¤ºå¤±è´¥æµ‹è¯•çš„è¾“å‡ºï¼Œè€Œä¸”ä¼šåœ¨æµ‹è¯•ç»“æœä¹‹åæ•´é½åœ°æ˜¾ç¤ºã€‚è¿™æ ·å¯ä»¥æ›´å®¹æ˜“åœ°å°†æµ‹è¯•ç»“æœä¸è¾“å‡ºåŒºåˆ†å¼€ã€‚é€šè¿‡æµ‹è¯•å°±ä¸ä¼šæœ‰è¾“å‡ºäº†ã€‚</p>
<p>æµ‹è¯•é‡Œé™¤äº† println!ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ dbg!()ï¼Œä¼šè‡ªåŠ¨æ‰“å°è¡¨è¾¾å¼å’Œè®¡ç®—åçš„å€¼ã€‚æ¯”å¦‚ <code>dbg!(addr);</code> è¿”å› <code>[tests/server.rs:15:5] addr = 127.0.0.1:57813</code>ã€‚</p>
<h2 id="å‘½ä»¤è¡Œå·¥å…·">å‘½ä»¤è¡Œå·¥å…·</h2>
<p>Rust ä¸­æœ€å¸¸è§çš„å‘½ä»¤è¡Œå‚æ•°è§£æåº“æ˜¯ clapã€‚æˆ‘ä»¬çœ‹ redis client çš„è®¾è®¡ï¼Œ</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta">#[derive(Parser, Debug)]</span></span><br><span class="line">#<span class="meta">#[command(</span></span><br><span class="line"><span class="meta">    name = <span class="string">"mini-redis-cli"</span>,</span></span><br><span class="line"><span class="meta">    version,</span></span><br><span class="line"><span class="meta">    author,</span></span><br><span class="line"><span class="meta">    about = <span class="string">"Issue Redis commands"</span></span></span><br><span class="line"><span class="meta">)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cli</span> {</span><br><span class="line">    <span class="meta">#[clap(subcommand)]</span></span><br><span class="line">    command: Command,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[arg(id = <span class="string">"hostname"</span>, long, default_value = <span class="string">"127.0.0.1"</span>)]</span></span><br><span class="line">    host: <span class="type">String</span>,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[arg(long, default_value_t = DEFAULT_PORT)]</span></span><br><span class="line">    port: <span class="type">u16</span>,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸€ä¸ªå­å‘½ä»¤ï¼ˆé€šè¿‡ Command æšä¸¾è¡¨ç¤ºï¼‰ï¼Œ<code>#[clap(subcommand)]</code> ä¼šå‘Šè¯‰ clap è¿™æ˜¯ä¸ªå­å‘½ä»¤ï¼ŒåŠ ä¸Šä»–ç»§æ‰¿Subcommandï¼Œå°±ä¼šè‡ªåŠ¨ç”Ÿæˆè§£æçš„ä»£ç ã€‚å­å‘½ä»¤é‡Œçš„å‚æ•°å­—æ®µï¼Œä¹Ÿå¯ä»¥å¢åŠ æ ‡ç­¾ã€‚è¿™ä¸ªè‡ªåŠ¨ç”ŸæˆåŠŸèƒ½ï¼Œæå¤§çš„ç®€åŒ–äº†å‘½ä»¤è§£æçš„è¿‡ç¨‹ã€‚<br>
é»˜è®¤å‚æ•°å¯ä»¥æ˜¯ç”¨ --å­—æ®µåï¼Œæˆ–è€…ç”¨å­—æ®µä½ç½®å¯¹åº”ã€‚</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta">#[derive(Subcommand, Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Command</span> {</span><br><span class="line">    Ping { msg: <span class="type">Option</span>&lt;Bytes&gt; },</span><br><span class="line">    Get { key: <span class="type">String</span> },</span><br><span class="line">    Set { key: <span class="type">String</span>, value: Bytes, expires: <span class="type">Option</span>&lt;Duration&gt; },</span><br><span class="line">    Publish { channel: <span class="type">String</span>, message: Bytes },</span><br><span class="line">    Subscribe { channels: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt; },</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden="">    
  </pre></div>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://www.blog-blockchain.xyz">Michael(Jiahao) Luo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://www.blog-blockchain.xyz/dev/study-mini-redis/">https://www.blog-blockchain.xyz/dev/study-mini-redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/rust/">rust</a></div><div class="post-share"><div class="social-share" data-image="https://cdn.blog-blockchain.xyz/2025/03/7a1eb877711a4e78b90307ccefde92f4.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/dev/rust-lifetime/" title="æ·±å…¥å­¦ä¹ Rustç”Ÿå‘½å‘¨æœŸ"><img class="cover" src="https://cdn.blog-blockchain.xyz/2025/03/7a1eb877711a4e78b90307ccefde92f4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">æ·±å…¥å­¦ä¹ Rustç”Ÿå‘½å‘¨æœŸ</div></div><div class="info-2"><div class="info-item-1">æ·±å…¥è§£æRustç”Ÿå‘½å‘¨æœŸæœºåˆ¶çš„æ ¸å¿ƒåŸç†å’Œæ¨å¯¼è§„åˆ™ï¼Œè¯¦ç»†è®¨è®ºå¾ªç¯å¼•ç”¨é—®é¢˜å’Œå¯å˜å¼•ç”¨é™åˆ¶ï¼Œæä¾›é¿å…ç”Ÿå‘½å‘¨æœŸé™·é˜±çš„å®ç”¨å»ºè®®å’Œæœ€ä½³å®è·µã€‚</div></div></div></a><a class="pagination-related" href="/dev/value-of-software-engineering/" title="ç¨‹åºå‘˜çš„ä»·å€¼åœ¨å“ªé‡Œ"><img class="cover" src="https://cdn.blog-blockchain.xyz/2025/05/819ee56cc884eb5c8194f7f9a2d94d8c.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">ç¨‹åºå‘˜çš„ä»·å€¼åœ¨å“ªé‡Œ</div></div><div class="info-2"><div class="info-item-1">ç¨‹åºå‘˜çš„æ ¸å¿ƒä»·å€¼æ˜¯åˆ©ç”¨æŠ€æœ¯ä¸ºä¼ä¸šåˆ›é€ ä¸šåŠ¡ä»·å€¼ï¼Œè€Œéçº¯ç²¹çš„æŠ€æœ¯èƒ½åŠ›ã€‚å…¶ä»·å€¼å…¬å¼ V=Î£ï¼ˆæŠ€æœ¯æ æ†ç‡Ã—ä¸šåŠ¡ä»·å€¼å¯†åº¦ï¼‰æ­ç¤ºäº†ä»·å€¼æ¥æºï¼šæŠ€æœ¯æ æ†æ”¾å¤§ä¸ªäººäº§å‡ºï¼Œä¸šåŠ¡ä»·å€¼å¯†åº¦å†³å®šåœºæ™¯æ½œåŠ›ã€‚ä¸åŒåœºæ™¯å’Œè¡Œä¸šå¯¹ç¨‹åºå‘˜ä»·å€¼ä¼°å€¼å„å¼‚ï¼Œé€šç”¨ä»·å€¼ä½“ç°åœ¨è§£å†³å¤æ‚é—®é¢˜ã€ä¼˜åŒ–æ€§èƒ½ã€æå‡æ•ˆç‡ã€æ¨åŠ¨åˆ›æ–°å’Œé™ä½æˆæœ¬ç­‰æ–¹é¢ã€‚ç¨‹åºå‘˜éœ€æ‹¥æŠ±å¤šå…ƒæŠ€æœ¯æ ˆï¼Œç²¾è¿›æ ¸å¿ƒæŠ€èƒ½ï¼Œæå‡ä¸šåŠ¡ç†è§£å’Œå¤åˆèƒ½åŠ›ã€‚æŠ€æœ¯ä»·å€¼å—ç¨€ç¼ºæ€§ã€é€‚é…åº¦å’Œæ³¡æ²«æº¢ä»·ç‡å½±å“ï¼Œéœ€è­¦æƒ•æŠ€æœ¯è¶…å‰ã€è·¯å¾„ä¾èµ–å’Œä¼ªéœ€æ±‚é™·é˜±ã€‚é€ƒç¦»æ³¡æ²«éœ€è¯†åˆ«èµ„æœ¬é€€æ½®ã€äººæ‰é™æ¸©ã€ç›‘ç®¡æ”¶ç´§ç­‰ä¿¡å·ï¼Œå¹¶æå‰è½¬å‹ã€æå‡èƒ½åŠ›ã€è°¨æ…æŠ•èµ„ã€æ‹“å±•äººè„‰å’Œç»ˆèº«å­¦ä¹ ã€‚</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/dev/rust-lifetime/" title="æ·±å…¥å­¦ä¹ Rustç”Ÿå‘½å‘¨æœŸ"><img class="cover" src="https://cdn.blog-blockchain.xyz/2025/03/7a1eb877711a4e78b90307ccefde92f4.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-28</div><div class="info-item-2">æ·±å…¥å­¦ä¹ Rustç”Ÿå‘½å‘¨æœŸ</div></div><div class="info-2"><div class="info-item-1">æ·±å…¥è§£æRustç”Ÿå‘½å‘¨æœŸæœºåˆ¶çš„æ ¸å¿ƒåŸç†å’Œæ¨å¯¼è§„åˆ™ï¼Œè¯¦ç»†è®¨è®ºå¾ªç¯å¼•ç”¨é—®é¢˜å’Œå¯å˜å¼•ç”¨é™åˆ¶ï¼Œæä¾›é¿å…ç”Ÿå‘½å‘¨æœŸé™·é˜±çš„å®ç”¨å»ºè®®å’Œæœ€ä½³å®è·µã€‚</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/site-avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info-name">Michael(Jiahao) Luo</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">56</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://x.com/jiahao_luo9"><i class="fa-brands fa-twitter"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://www.linkedin.com/in/jiahao-michael-luo-8ba5942a3" rel="external nofollow noreferrer" target="_blank" title="Linkedin"><i class="fa-brands fa-linkedin"></i></a><a class="social-icon" href="https://x.com/jiahao_luo9" rel="external nofollow noreferrer" target="_blank" title="Twitter"><i class="fa-brands fa-twitter"></i></a><a class="social-icon" href="https://github.com/learnerLj" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:luoshitou9@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSSé“¾æ¥"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">ä»æŠ€æœ¯åˆ°å•†ä¸šï¼Œä»äº§å“åˆ°è®¾è®¡ï¼Œä»ç”Ÿæ´»åˆ°æœªæ¥ï¼Œæˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«æˆ‘çš„æ‰€æ€æ‰€æƒ³ï¼Œæ¬¢è¿å…³æ³¨ï¼</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"><span class="toc-text">é¡¹ç›®æ¶æ„æ¦‚è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-text">å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#db-%E6%A8%A1%E5%9D%97"><span class="toc-text">db æ¨¡å—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1"><span class="toc-text">æ•°æ®ç»“æ„å’Œåå°ä»»åŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%92%8C%E5%86%99"><span class="toc-text">è¯»å’Œå†™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pub-Sub"><span class="toc-text">Pub/Sub</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E5%8D%8F%E8%AE%AE%E5%B8%A7"><span class="toc-text">Redisåè®®å¸§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%A8%A1%E5%9D%97"><span class="toc-text">è¿æ¥æ¨¡å—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E5%9D%97"><span class="toc-text">æœåŠ¡å™¨æ¨¡å—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%9D%97"><span class="toc-text">å®¢æˆ·ç«¯æ¨¡å—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B"><span class="toc-text">æ”¹è¿›</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-text">å­¦ä¹ é¡¹ç›®ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E6%B5%8B%E8%AF%95"><span class="toc-text">å­¦ä¹ æµ‹è¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-text">å‘½ä»¤è¡Œå·¥å…·</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/defi/hyperliquid/" title="Hyperliquid æ·±åº¦è°ƒç ”æŠ¥å‘Š"><img src="https://cdn.blog-blockchain.xyz/2025/08/fb9eea41890628fa5f769e1e85c59609.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hyperliquid æ·±åº¦è°ƒç ”æŠ¥å‘Š"></a><div class="content"><a class="title" href="/defi/hyperliquid/" title="Hyperliquid æ·±åº¦è°ƒç ”æŠ¥å‘Š">Hyperliquid æ·±åº¦è°ƒç ”æŠ¥å‘Š</a><time datetime="2025-08-08T00:49:22.000Z" title="Created 2025-08-08 08:49:22">2025-08-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/finance/ltcm-risk-management-case-study/" title="åå°”è¡—&quot;æ¢¦å¹»å›¢é˜Ÿ&quot;çš„æƒ¨ç—›æ•™è®­ï¼šLTCMå¦‚ä½•åœ¨4ä¸ªæœˆå†…æŸå¤±46äº¿ç¾å…ƒ"><img src="https://cdn.blog-blockchain.xyz/2025/07/3aeebf60c26b2a9809d7091517c4f856.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åå°”è¡—&quot;æ¢¦å¹»å›¢é˜Ÿ&quot;çš„æƒ¨ç—›æ•™è®­ï¼šLTCMå¦‚ä½•åœ¨4ä¸ªæœˆå†…æŸå¤±46äº¿ç¾å…ƒ"></a><div class="content"><a class="title" href="/finance/ltcm-risk-management-case-study/" title="åå°”è¡—&quot;æ¢¦å¹»å›¢é˜Ÿ&quot;çš„æƒ¨ç—›æ•™è®­ï¼šLTCMå¦‚ä½•åœ¨4ä¸ªæœˆå†…æŸå¤±46äº¿ç¾å…ƒ">åå°”è¡—"æ¢¦å¹»å›¢é˜Ÿ"çš„æƒ¨ç—›æ•™è®­ï¼šLTCMå¦‚ä½•åœ¨4ä¸ªæœˆå†…æŸå¤±46äº¿ç¾å…ƒ</a><time datetime="2025-07-27T06:31:00.000Z" title="Created 2025-07-27 14:31:00">2025-07-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/finance/ftx-alameda-collapse-case-study/" title="320äº¿ç¾å…ƒæ¶ˆå¤±è®°ï¼šFTXå¸å›½å´©å¡ŒèƒŒåçš„äººæ€§è´ªå©ªä¸åˆ¶åº¦å¤±æ•ˆ"><img src="https://cdn.blog-blockchain.xyz/2025/07/449fc564e4e9aa38a6eaf425abc6ef44.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="320äº¿ç¾å…ƒæ¶ˆå¤±è®°ï¼šFTXå¸å›½å´©å¡ŒèƒŒåçš„äººæ€§è´ªå©ªä¸åˆ¶åº¦å¤±æ•ˆ"></a><div class="content"><a class="title" href="/finance/ftx-alameda-collapse-case-study/" title="320äº¿ç¾å…ƒæ¶ˆå¤±è®°ï¼šFTXå¸å›½å´©å¡ŒèƒŒåçš„äººæ€§è´ªå©ªä¸åˆ¶åº¦å¤±æ•ˆ">320äº¿ç¾å…ƒæ¶ˆå¤±è®°ï¼šFTXå¸å›½å´©å¡ŒèƒŒåçš„äººæ€§è´ªå©ªä¸åˆ¶åº¦å¤±æ•ˆ</a><time datetime="2025-07-27T06:26:20.000Z" title="Created 2025-07-27 14:26:20">2025-07-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/finance/binance-unified-account-risk-analysis/" title="å¸å®‰ç»Ÿä¸€è´¦æˆ·ä¿è¯é‡‘äº¤æ˜“çš„é£é™©åˆ†æä¸ç®¡ç†ç­–ç•¥"><img src="https://cdn.blog-blockchain.xyz/2025/07/38b70ba52e268082e1304ae0b5545153.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å¸å®‰ç»Ÿä¸€è´¦æˆ·ä¿è¯é‡‘äº¤æ˜“çš„é£é™©åˆ†æä¸ç®¡ç†ç­–ç•¥"></a><div class="content"><a class="title" href="/finance/binance-unified-account-risk-analysis/" title="å¸å®‰ç»Ÿä¸€è´¦æˆ·ä¿è¯é‡‘äº¤æ˜“çš„é£é™©åˆ†æä¸ç®¡ç†ç­–ç•¥">å¸å®‰ç»Ÿä¸€è´¦æˆ·ä¿è¯é‡‘äº¤æ˜“çš„é£é™©åˆ†æä¸ç®¡ç†ç­–ç•¥</a><time datetime="2025-07-27T05:55:20.000Z" title="Created 2025-07-27 13:55:20">2025-07-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/finance/binance-unified-account-margin-trading-guide/" title="å¸å®‰ç»Ÿä¸€è´¦æˆ·ä¸ä¿è¯é‡‘äº¤æ˜“å®Œæ•´æŒ‡å—"><img src="https://cdn.blog-blockchain.xyz/2025/07/38b70ba52e268082e1304ae0b5545153.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å¸å®‰ç»Ÿä¸€è´¦æˆ·ä¸ä¿è¯é‡‘äº¤æ˜“å®Œæ•´æŒ‡å—"></a><div class="content"><a class="title" href="/finance/binance-unified-account-margin-trading-guide/" title="å¸å®‰ç»Ÿä¸€è´¦æˆ·ä¸ä¿è¯é‡‘äº¤æ˜“å®Œæ•´æŒ‡å—">å¸å®‰ç»Ÿä¸€è´¦æˆ·ä¸ä¿è¯é‡‘äº¤æ˜“å®Œæ•´æŒ‡å—</a><time datetime="2025-07-27T05:26:20.000Z" title="Created 2025-07-27 13:26:20">2025-07-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">Â©2020 - 2025 By Michael(Jiahao) Luo</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zindex="-1" mobile="false" data-click="false"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js?v=1754642563450"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div></div></div><script src="/bundle.js"></script><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css')
    if (false) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})();
(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})();
(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: '467d9506710fff22dc33',
      clientSecret: '2a3e530b895af9c94d4bbe95fe78c69317f4d76e',
      repo: 'blog-gitalk',
      owner: 'learnerLj',
      admin: ['learnerLj'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || 'c277fc36e2887763b801dc17528f7d17'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></body></html>